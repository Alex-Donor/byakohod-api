<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ë—è–∫–æ–•–æ–¥ ‚Äî –æ—Ü–∏—Ñ—Ä–æ–≤–∫–∞</title>
  <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- –î–æ–±–∞–≤–ª—è–µ–º Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Calibri, Arial, sans-serif;
      overflow: hidden;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    #map {
      width: 100%;
      height: 100vh;
    }
    #menu-button {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 40px;
      height: 40px;
      background: white;
      border: 2px solid #ccc;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      z-index: 1001;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
    }
    #menu-button span {
      display: block;
      width: 4px;
      height: 4px;
      background: #333;
      border-radius: 50%;
      margin: 1px 0;
    }
    #dropdown-menu {
      display: none;
      position: absolute;
      top: 55px;
      left: 10px;
      background: #e8e8e8;
      padding: 16px 12px;
      border-radius: 8px;
      box-shadow: 0 0 12px rgba(0,0,0,0.5);
      z-index: 1000;
      font-size: 16px;
      font-family: Calibri, Arial, sans-serif;
    }
    #dropdown-menu.active {
      display: block;
    }
    .menu-section {
      margin-bottom: 12px;
    }
    .menu-label {
      display: block;
      font-weight: bold;
      color: #222;
      margin-bottom: 6px;
      font-size: 16px;
    }
    select {
      width: 200px;
      padding: 6px;
      font-size: 16px;
      border: 1px solid #999;
      border-radius: 4px;
      background: white;
      font-family: Calibri, Arial, sans-serif;
    }
    #search-btn,
    #legend-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 40px;
      height: 40px;
      background: white;
      border: 2px solid #ccc;
      border-radius: 6px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      font-size: 20px;
      color: #333;
      z-index: 1002;
    }
    #legend-btn {
      right: 58px;
    }
    #search-panel,
    #legend-panel {
      position: absolute;
      top: 58px;
      right: 12px;
      width: 220px;
      display: none;
      z-index: 1003;
      background: white;
      padding: 12px;
      border: 2px solid #aaa;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      font-family: Calibri, Arial, sans-serif;
      font-size: 16px;
    }
    #legend-panel {
      right: 58px;
      width: 280px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin: 6px 0;
      white-space: nowrap;
    }
    .legend-color {
      width: 20px;
      height: 4px;
      margin-right: 8px;
      border-radius: 2px;
    }
    #search-input {
      width: 100%;
      padding: 8px 12px;
      border: 2px solid #aaa;
      border-radius: 4px;
      font-size: 16px;
      font-family: Calibri, Arial, sans-serif;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    #search-results {
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border: 2px solid #aaa;
      border-top: none;
      border-radius: 0 0 6px 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: none;
    }
    .search-result-item {
      padding: 6px 12px;
      cursor: pointer;
      font-size: 16px;
      font-family: Calibri, Arial, sans-serif;
      border-bottom: 1px solid #eee;
    }
    .search-result-item:hover {
      background-color: #f0f8ff;
    }

    /* –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
    #control-panel {
      position: absolute;
      top: 12px;
      left: 60px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
    }

    .control-btn {
      width: 30px;
      height: 30px;
      background: white;
      border: 1px solid rgba(0,0,0,0.2);
      border-radius: 4px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .control-btn:hover {
      background: #f0f0f0;
    }

    #points-toggle-btn {
      font-size: 16px;
    }

    #points-toggle-btn.active {
      background: #4CAF50;
      color: white;
      border-color: #45a049;
    }

    #copyright {
      font-size: 15px;
      white-space: nowrap;
      font-weight: bold;
      margin-left: 8px;
    }
    #copyright a {
      text-decoration: none;
      color: #0066cc;
    }

    .leaflet-control-attribution {
      display: none !important;
    }

    .popup-option {
      display: flex;
      align-items: center;
      padding: 6px 10px;
      margin: 4px 0;
      cursor: pointer;
      border-radius: 4px;
      font-family: Calibri, Arial, sans-serif;
      font-size: 16px;
    }
    .popup-option:hover {
      background-color: #f0f8ff;
    }
    .color-line {
      width: 30px;
      height: 4px;
      margin-right: 10px;
      border-radius: 2px;
    }

    .save-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      z-index: 10000;
      font-family: Calibri, Arial, sans-serif;
      font-size: 16px;
      display: none;
    }

    .export-btn {
      position: absolute;
      top: 12px;
      right: 104px;
      width: 40px;
      height: 40px;
      background: white;
      border: 2px solid #ccc;
      border-radius: 6px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      font-size: 20px;
      color: #333;
      z-index: 1002;
    }

    .export-btn.disabled {
      background: #cccccc !important;
      cursor: not-allowed !important;
      opacity: 0.6;
    }

    .export-btn.disabled:hover {
      background: #cccccc !important;
    }

    .export-tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 14px;
      white-space: nowrap;
      z-index: 10000;
      pointer-events: none;
    }

    /* –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò */
    #auth-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }

    #auth-modal.active {
      display: flex;
    }

    #auth-panel {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 0 25px rgba(0,0,0,0.5);
      z-index: 10001; /* –í–∞–∂–Ω–æ: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã—à–µ —á–µ–º —Ñ–æ–Ω */
      text-align: center;
      width: 350px;
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
      position: relative; /* –î–æ–±–∞–≤–ª—è–µ–º –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
    }

    #auth-email, #auth-password {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: Calibri, Arial, sans-serif;
      font-size: 16px;
      box-sizing: border-box;
      background: white;
    }

    #auth-button {
      width: 100%;
      padding: 12px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: Calibri, Arial, sans-serif;
      font-size: 16px;
      margin-top: 10px;
    }

    #auth-button:hover {
      background: #0055aa;
    }

    #anonymous-button {
      width: 100%;
      padding: 12px;
      background: #666;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: Calibri, Arial, sans-serif;
      font-size: 16px;
      margin-top: 8px;
    }

    #anonymous-button:hover {
      background: #555;
    }

    .auth-divider {
      margin: 15px 0;
      border-top: 1px solid #ddd;
      position: relative;
    }

    .auth-divider-text {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 0 10px;
      color: #666;
      font-size: 14px;
    }

    #user-info {
      position: absolute;
      top: 12px;
      right: 150px;
      background: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      border: 1px solid #ccc;
      z-index: 1002;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #logout-btn {
      background: #ff4444;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 13px;
      font-family: Calibri, Arial, sans-serif;
    }

    #logout-btn:hover {
      background: #cc0000;
    }

    .user-role-badge {
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 12px;
      color: #666;
    }

    .user-action-btn {
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 13px;
      font-family: Calibri, Arial, sans-serif;
    }

    .user-action-btn:hover {
      background: #45a049;
    }

    .user-action-btn.secondary {
      background: #2196F3;
    }

    .user-action-btn.secondary:hover {
      background: #0b7dda;
    }

    .auth-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }

    .auth-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      border: none;
      background: none;
      font-family: Calibri, Arial, sans-serif;
      font-size: 16px;
      transition: background-color 0.3s;
    }

    .auth-tab.active {
      background: #0066cc;
      color: white;
      border-radius: 4px 4px 0 0;
    }

    .auth-tab:hover:not(.active) {
      background: #f0f0f0;
    }

    .auth-form {
      display: none;
    }

    .auth-form.active {
      display: block;
    }

    #register-name,
    #register-email,
    #register-password,
    #register-password-confirm {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: Calibri, Arial, sans-serif;
      font-size: 16px;
      box-sizing: border-box;
      background: white;
    }

    .password-match {
      color: #4CAF50;
      font-size: 14px;
      margin-top: -5px;
      margin-bottom: 10px;
    }

    .password-mismatch {
      color: #f44336;
      font-size: 14px;
      margin-top: -5px;
      margin-bottom: 10px;
    }

    #register-button {
      width: 100%;
      padding: 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: Calibri, Arial, sans-serif;
      font-size: 16px;
      margin-top: 10px;
    }

    #register-button:hover {
      background: #45a049;
    }

    #register-button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }

    .auth-message {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      font-size: 14px;
      text-align: center;
    }

    .auth-success {
      background: #dff0d8;
      color: #3c763d;
      border: 1px solid #d6e9c6;
    }

    .auth-error {
      background: #f2dede;
      color: #a94442;
      border: 1px solid #ebccd1;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ */
    .comment-section {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #ddd;
    }

    .comment-label {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 14px;
    }

    .comment-text {
      font-size: 13px;
      color: #666;
      margin-bottom: 5px;
      word-break: break-word;
    }

    .comment-input {
      width: 100%;
      padding: 6px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-family: Calibri, Arial, sans-serif;
      box-sizing: border-box;
    }

    .comment-save-btn {
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 13px;
      font-family: Calibri, Arial, sans-serif;
      margin-top: 5px;
    }

    .comment-save-btn:hover {
      background: #45a049;
    }

    .comment-edit-btn {
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 12px;
      font-family: Calibri, Arial, sans-serif;
      margin-top: 3px;
    }

    .comment-edit-btn:hover {
      background: #0b7dda;
    }

    .no-comment {
      font-style: italic;
      color: #999;
      font-size: 13px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–¥–ø–∏—Å–µ–π —Ç–æ—á–µ–∫ */
    .point-label {
      font-family: Calibri, Arial, sans-serif;
      font-size: 12px;
      font-weight: bold;
      color: #333;
      background: rgba(255, 255, 200, 0.85); /* –°–≤–µ—Ç–ª–æ-–∂–µ–ª—Ç–∞—è –∑–∞–ª–∏–≤–∫–∞ */
      padding: 2px 4px;
      border-radius: 3px;
      border: 1px solid #ccc;
      pointer-events: none;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—Ç–∫–∞–∑–∞ –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ */
    #disclaimer-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }

    #disclaimer-modal.active {
      display: flex;
    }

    .disclaimer-content {
      background: white;
      padding: 25px;
      border-radius: 8px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 0 25px rgba(0,0,0,0.5);
      font-family: Calibri, Arial, sans-serif;
      z-index: 10001;
      position: relative;
    }

    .disclaimer-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #d32f2f;
      text-align: center;
    }

    .disclaimer-text {
      font-size: 14px;
      line-height: 1.5;
      color: #333;
      margin-bottom: 20px;
    }

    .disclaimer-close-btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-family: Calibri, Arial, sans-serif;
      font-size: 16px;
      display: block;
      margin: 0 auto;
    }

    .disclaimer-close-btn:hover {
      background: #45a049;
    }

    .disclaimer-menu-item {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      margin-top: 8px;
      background: #f5f5f5;
      border: 1px solid #ddd;
      font-family: Calibri, Arial, sans-serif;
      font-size: 14px;
      text-align: center;
    }

    .disclaimer-menu-item:hover {
      background: #e8e8e8;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
    #loading-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10001;
      justify-content: center;
      align-items: center;
    }

    #loading-modal.active {
      display: flex;
    }

    .loading-content {
      background: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 0 25px rgba(0,0,0,0.5);
      font-family: Calibri, Arial, sans-serif;
      z-index: 10002;
      position: relative;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    .loading-text {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105377882', 'ym');

    ym(105377882, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true, ut: "noindex"});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105377882" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
	
</head>
<body>
<div id="menu-button">
  <span></span>
  <span></span>
  <span></span>
</div>

<!-- –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
<div id="control-panel">
  <div class="control-btn" id="zoom-in">+</div>
  <div class="control-btn" id="zoom-out">‚àí</div>
  <div class="control-btn" id="points-toggle-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Ç–æ—á–∫–∏">üìç</div>
  <div id="copyright">
    <a href="https://t.me/Aleks_Donor" target="_blank" rel="noopener">¬© by Alex Donor</a>
  </div>
</div>

<div id="dropdown-menu">
  <div class="menu-section">
    <span class="menu-label">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É:</span>
    <select id="background-select">
      <option value="custom">–ë–∞–∑–æ–≤–∞—è –∫–∞—Ä—Ç–∞</option>
      <option value="custom2">–ö–∞—Ä—Ç–∞ —Å –∑–∞–ª–∏–≤–∫–æ–π</option>
      <option value="osm">OpenStreetMap</option>
      <option value="google_satellite">Google Satellite</option>
    </select>
  </div>
  
  <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—Ç–∫–∞–∑–∞ –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ -->
  <div class="menu-section">
    <div class="disclaimer-menu-item" id="disclaimer-menu-btn">
      üìÑ –û—Ç–∫–∞–∑ –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
<div id="auth-modal" class="active">
  <div id="auth-panel">
    <div class="auth-tabs">
      <button class="auth-tab active" data-tab="login">–í—Ö–æ–¥</button>
      <button class="auth-tab" data-tab="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>

    <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
    <div id="login-form" class="auth-form active">
      <h3>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
      <input type="email" id="auth-email" placeholder="Email">
      <input type="password" id="auth-password" placeholder="–ü–∞—Ä–æ–ª—å">
      <button id="auth-button">–í–æ–π—Ç–∏</button>
      
      <div class="auth-divider">
        <div class="auth-divider-text">–∏–ª–∏</div>
      </div>
      
      <button id="anonymous-button">–í–æ–π—Ç–∏ –∫–∞–∫ –≥–æ—Å—Ç—å</button>
      <div style="margin-top: 15px; font-size: 14px; color: #666;">
        <strong>–ì–æ—Å—Ç—å:</strong> –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ä—Ç—ã –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      </div>
    </div>

    <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <div id="register-form" class="auth-form">
      <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
      <input type="text" id="register-name" placeholder="–í–∞—à–µ –∏–º—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" required>
      <input type="email" id="register-email" placeholder="Email" required>
      <input type="password" id="register-password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)" required>
      <input type="password" id="register-password-confirm" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
      <div id="password-match-message"></div>
      <button id="register-button" disabled>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      
      <div style="margin-top: 15px; font-size: 13px; color: #666; text-align: center;">
        –ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à—É –ø–æ—á—Ç—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email
      </div>
    </div>

    <div id="auth-message"></div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div id="loading-modal">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div class="loading-text">–ü–æ–¥–æ–∂–¥–∏—Ç–µ! –ò–¥—ë—Ç –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ä—Ç—ã!</div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫–∞–∑–∞ –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ -->
<div id="disclaimer-modal">
  <div class="disclaimer-content">
    <div class="disclaimer-title">–í–ù–ò–ú–ê–ù–ò–ï: –û–¢–ö–ê–ó –û–¢ –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–ò</div>
    <div class="disclaimer-text">
      <p><strong>–ù–∞—Å—Ç–æ—è—â–µ–µ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ –Ω–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –∏ –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª—è—Ö.</strong></p>
      
      <p>–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–¥–∑–µ–º–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–∞—Ö, —à–∞—Ö—Ç–∞—Ö, –ø–µ—â–µ—Ä–∞—Ö –∏ –∏–Ω—ã—Ö –ø–æ–¥–∑–µ–º–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞—Ö –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è "–∫–∞–∫ –µ—Å—Ç—å" –∏ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏, –æ—à–∏–±–∫–∏ –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–≤—à—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –ö–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–æ—Å—è—Ç –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä.</p>

      <p><strong>–ê–≤—Ç–æ—Ä –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –Ω–µ—Å—É—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞:</strong></p>
      <ul>
        <li>–õ—é–±–æ–π —É—â–µ—Ä–±, —Ç—Ä–∞–≤–º—ã –∏–ª–∏ –∏–Ω—ã–µ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è, –≤–æ–∑–Ω–∏–∫—à–∏–µ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö</li>
        <li>–¢–æ—á–Ω–æ—Å—Ç—å –∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</li>
        <li>–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã</li>
        <li>–õ—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø–æ–¥–∑–µ–º–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤, –ø—Ä–æ–∏–∑–æ—à–µ–¥—à–∏–µ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç</li>
      </ul>

      <p><strong>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∑–µ–º–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ —Å–≤—è–∑–∞–Ω–æ —Å –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π –æ–ø–∞—Å–Ω–æ—Å—Ç—å—é!</strong> –î–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤ –ø–æ–¥–∑–µ–º–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö –∏ –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç:</p>
      <ul>
        <li>–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å–ø–µ–ª–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</li>
        <li>–û–ø—ã—Ç–∞ –∏ –∑–Ω–∞–Ω–∏–π –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤</li>
        <li>–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –∏ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è</li>
        <li>–°—Ä–µ–¥—Å—Ç–≤ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã</li>
      </ul>

      <p><strong>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ —Å–≤–æ–π —Å—Ç—Ä–∞—Ö –∏ —Ä–∏—Å–∫.</strong> –ù–µ –ø–æ–¥–≤–µ—Ä–≥–∞–π—Ç–µ —Å–≤–æ—é –∂–∏–∑–Ω—å –∏ –∑–¥–æ—Ä–æ–≤—å–µ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –ø–æ–ª–∞–≥–∞—è—Å—å –Ω–∞ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã.</p>

      <p>–ü–æ–º–Ω–∏—Ç–µ: –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å - —ç—Ç–æ –≤–∞—à–∞ –ª–∏—á–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å!</p>
    </div>
    <button class="disclaimer-close-btn" id="disclaimer-close-btn">–ü–æ–Ω—è—Ç–Ω–æ</button>
  </div>
</div>

<button id="legend-btn">üõà</button>
<button id="search-btn">üîç</button>
<button class="export-btn" id="export-btn" title="–≠–∫—Å–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç–æ–≤">üíæ</button>
<div id="user-info" style="display: none;">
  <span id="user-email"></span>
  <span id="user-role" class="user-role-badge"></span>
  <button id="resend-verification-btn" class="user-action-btn secondary" style="display: none;">üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</button>
  <button id="reload-page-btn" class="user-action-btn">‚Üª –ü–µ—Ä–µ–∑–∞–π—Ç–∏</button>
  <button id="logout-btn">–í—ã–π—Ç–∏</button>
</div>

<div id="legend-panel">
  <div class="legend-item">
    <div class="legend-color" style="background-color: #8B4513;"></div>
    <span>–ó–∞–≤–∞–ª (1)</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background-color: #ff0000;"></div>
    <span>–®–∫—É—Ä–æ–¥–µ—Ä (2)</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background-color: #ff6700;"></div>
    <span>–ü—Ä–æ—Ö–æ–¥ —Å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ–º (3)</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background-color: #0066ff;"></div>
    <span>–û–±–≤–æ–¥–Ω–µ–Ω–Ω—ã–π —à—Ç—Ä–µ–∫ (4)</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background-color: #006400;"></div>
    <span>–°–≤–æ–±–æ–¥–Ω—ã–π –ø—Ä–æ—Ö–æ–¥ (5)</span>
  </div>
</div>

<div id="search-panel">
  <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ —Ç–æ—á–µ–∫...">
  <div id="search-results"></div>
</div>

<div id="map"></div>

<div id="save-notification" class="save-notification">–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // === Firebase Configuration ===
  const firebaseConfig = {
    apiKey: "AIzaSyAFFLaRyH4CoEWd8lZqW7aRWwOp3OkfI0Y",
    authDomain: "byakitb.firebaseapp.com",
    projectId: "byakitb",
    storageBucket: "byakitb.firebasestorage.app",
    messagingSenderId: "39005850684",
    appId: "1:39005850684:web:f6e5b4904482af3cc9c739"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  // === –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ===
  let map;
  let currentImageOverlay = null;
  let currentTileLayer = null;
  let mapBounds = null;
  let networkLayerGroup;
  let allPointsGeoJson = null;
  let geoJsonData = null;
  let firestoreData = new Map();
  let currentUserRole = 'anonymous';
  let currentMapType = 'custom';
  let currentUserEmail = null;
  let currentUserName = null;
  let pointsLayerGroup = null;
  let pointsVisible = false;

  // === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º –∑–∞–≥—Ä—É–∑–∫–∏ ===
  function showLoadingModal() {
    document.getElementById('loading-modal').classList.add('active');
  }

  function hideLoadingModal() {
    document.getElementById('loading-modal').classList.remove('active');
  }

  // === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ===
  function showAuthModal() {
    document.getElementById('auth-modal').classList.add('active');
  }

  function hideAuthModal() {
    document.getElementById('auth-modal').classList.remove('active');
  }

  // === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ú–æ—Å–∫–æ–≤—Å–∫–∏–º –≤—Ä–µ–º–µ–Ω–µ–º ===
  function getMoscowTimestamp() {
    return firebase.firestore.Timestamp.fromDate(new Date());
  }

  function formatMoscowDateTime(date) {
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${day}.${month}.${year} ${hours}:${minutes}`;
  }

  function getMoscowDateTime() {
    return formatMoscowDateTime(new Date());
  }

  // === –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —ç–∫—Å–ø–æ—Ä—Ç—É ===
  function canUserExport() {
    return currentUserEmail === 'bognachev@mail.ru' && currentUserRole === 'verified';
  }

  // === –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ===
  function canUserEdit() {
    const user = auth.currentUser;
    if (!user || user.isAnonymous) {
      return false;
    }
    
    console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', {
      email: user.email,
      emailVerified: user.emailVerified,
      isAnonymous: user.isAnonymous
    });
    
    return user.emailVerified === true;
  }

  // === –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ ===
  function updateExportButtonState() {
    const exportBtn = document.getElementById('export-btn');
    const canExport = canUserExport();
    
    if (canExport) {
      exportBtn.classList.remove('disabled');
      exportBtn.title = '–≠–∫—Å–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç–æ–≤ –≤ GeoJSON';
    } else {
      exportBtn.classList.add('disabled');
      if (currentUserEmail) {
        if (currentUserRole === 'unverified') {
          exportBtn.title = '–î–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ email';
        } else {
          exportBtn.title = '–≠–∫—Å–ø–æ—Ä—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è bognachev@mail.ru';
        }
      } else {
        exportBtn.title = '–î–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É';
      }
    }
  }

  // === –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏ ===
  function showTooltip(message, element) {
    const tooltip = document.createElement('div');
    tooltip.className = 'export-tooltip';
    tooltip.textContent = message;
    
    const rect = element.getBoundingClientRect();
    tooltip.style.left = (rect.left + window.pageXOffset) + 'px';
    tooltip.style.top = (rect.top + window.pageYOffset - 30) + 'px';
    
    document.body.appendChild(tooltip);
    
    setTimeout(() => {
      if (tooltip.parentNode) {
        tooltip.parentNode.removeChild(tooltip);
      }
    }, 2000);
  }

  // === –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ ===
  async function saveRoutesToFile() {
    if (!canUserExport()) {
      const exportBtn = document.getElementById('export-btn');
      if (currentUserEmail) {
        if (currentUserRole === 'unverified') {
          showTooltip('–î–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ email', exportBtn);
        } else {
          showTooltip('–≠–∫—Å–ø–æ—Ä—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è bognachev@mail.ru', exportBtn);
        }
      } else {
        showTooltip('–î–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', exportBtn);
      }
      return false;
    }

    try {
      const routesToSave = { 
        type: "FeatureCollection", 
        features: [],
        metadata: {
          exported_by: currentUserEmail,
          export_date: new Date().toISOString(),
          firebase_data: true
        }
      };

      const seen = new Set();
      
      geoJsonData.features.forEach(feature => {
        const objectId = feature.properties?.OBJECTID;
        
        let firestoreDataForFeature = null;
        for (let [docId, data] of firestoreData) {
          if (data.fb_objectid == objectId) {
            firestoreDataForFeature = data;
            break;
          }
        }

        const mergedFeature = {
          ...feature,
          properties: {
            ...feature.properties,
            ...firestoreDataForFeature
          }
        };

        if (!seen.has(objectId)) {
          seen.add(objectId);
          routesToSave.features.push(mergedFeature);
        }
      });

      routesToSave.metadata.total_features = routesToSave.features.length;
      routesToSave.metadata.firestore_records = firestoreData.size;

      console.log('–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö:', {
        features: routesToSave.features.length,
        firestoreRecords: firestoreData.size,
        exportedBy: currentUserEmail
      });

      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(routesToSave, null, 2));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", `routes_export_${new Date().toISOString().slice(0, 10)}_${currentUserEmail.split('@')[0]}.geojson`);
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
      
      console.log('–ú–∞—Ä—à—Ä—É—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ —Ñ–∞–π–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º:', currentUserEmail);
      
      showSaveNotification('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ GeoJSON!');
      return true;
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
      return false;
    }
  }

  // === –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç ===
  function webMercatorToWGS84(x, y) {
    if (Math.abs(x) < 180 && Math.abs(y) < 90) {
      return [x, y];
    }
    
    const earthRadius = 6378137;
    const halfCircumference = Math.PI * earthRadius;
    
    const lon = (x / halfCircumference) * 180;
    let lat = (y / halfCircumference) * 180;
    lat = 180 / Math.PI * (2 * Math.atan(Math.exp(lat * Math.PI / 180)) - Math.PI / 2);
    
    return [lon, lat];
  }

  function transformCoordsForTileMaps(coords) {
    return coords.map(pt => {
      let x = pt[0], y = pt[1];
      
      if (Math.abs(x) > 180 || Math.abs(y) > 90) {
        [x, y] = webMercatorToWGS84(x, y);
      }
      
      return [y, x];
    });
  }

  function transformCoordsForCustomMaps(coords) {
    return coords.map(pt => [pt[1], pt[0]]);
  }

  // === –§—É–Ω–∫—Ü–∏—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è —Ç–æ—á–µ–∫ ===
  function transformPointCoords(coord, mapType) {
    let x = coord[0], y = coord[1];
    
    if (mapType === 'osm' || mapType === 'google_satellite') {
      if (Math.abs(x) > 180 || Math.abs(y) > 90) {
        [x, y] = webMercatorToWGS84(x, y);
      }
      return [y, x];
    } else {
      // –î–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫–∞—Ä—Ç
      return [y, x];
    }
  }

  // === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–¥–ª–æ–∂–∫–∞–º–∏ ===
  function createTileLayer(type) {
    showLoadingModal();
    
    currentMapType = type;
    
    console.log('–°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ—è:', type);
    
    if (currentImageOverlay) {
      map.removeLayer(currentImageOverlay);
      currentImageOverlay = null;
    }
    if (currentTileLayer) {
      map.removeLayer(currentTileLayer);
      currentTileLayer = null;
    }

    setTimeout(() => {
      try {
        switch(type) {
          case 'custom':
            console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–∞—Ä—Ç—ã');
            map.options.crs = L.CRS.Simple;
            map.setMinZoom(0.05);
            map.setMaxZoom(5);
            
            if (mapBounds) {
              currentImageOverlay = L.imageOverlay('maps/byaki.png', mapBounds, { opacity: 1 }).addTo(map);
              setTimeout(() => {
                map.fitBounds(mapBounds);
                redrawGeometryForCurrentCRS();
              }, 100);
            }
            break;
          
          case 'custom2':
            console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–∞—Ä—Ç—ã 2');
            map.options.crs = L.CRS.Simple;
            map.setMinZoom(0.05);
            map.setMaxZoom(5);
            
            if (mapBounds) {
              currentImageOverlay = L.imageOverlay('maps/map2.png', mapBounds, { opacity: 1 }).addTo(map);
              setTimeout(() => {
                map.fitBounds(mapBounds);
                redrawGeometryForCurrentCRS();
              }, 100);
            }
            break;
          
          case 'osm':
            console.log('–ó–∞–≥—Ä—É–∑–∫–∞ OSM');
            map.options.crs = L.CRS.EPSG3857;
            map.setMinZoom(0);
            map.setMaxZoom(20);
            
            currentTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '¬© OpenStreetMap contributors',
              maxZoom: 20
            }).addTo(map);
            
            redrawGeometryForCurrentCRS();
            break;
          
          case 'google_satellite':
            console.log('–ó–∞–≥—Ä—É–∑–∫–∞ Google Satellite');
            map.options.crs = L.CRS.EPSG3857;
            map.setMinZoom(0);
            map.setMaxZoom(20);
            
            currentTileLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
              attribution: '¬© Google',
              maxZoom: 20
            }).addTo(map);
            
            redrawGeometryForCurrentCRS();
            break;
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–ª–æ—è:', error);
      } finally {
        // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
        setTimeout(hideLoadingModal, 500);
      }
    }, 100);
  }

  function redrawGeometryForCurrentCRS() {
    if (!geoJsonData || !networkLayerGroup) {
      console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏');
      hideLoadingModal();
      return;
    }

    console.log('–ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –≥–µ–æ–º–µ—Ç—Ä–∏–∏ –¥–ª—è —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã:', currentMapType);
    networkLayerGroup.clearLayers();

    const transformFunction = (currentMapType === 'custom' || currentMapType === 'custom2') 
      ? transformCoordsForCustomMaps 
      : transformCoordsForTileMaps;

    let featuresDrawn = 0;
    
    geoJsonData.features.forEach((f, index) => {
      if (!f.geometry) return;
      
      let lines = [];
      if (f.geometry.type === 'LineString') lines = [f.geometry.coordinates];
      else if (f.geometry.type === 'MultiLineString') lines = f.geometry.coordinates;
      else return;

      const weight = f.properties?.weight || 5;
      const color = getRouteColor(weight);
      const visibleWeight = getRouteWeightByZoom(map.getZoom());

      lines.forEach((coords, lineIndex) => {
        if (coords.length < 2) return;
        
        const latlngs = transformFunction(coords);

        const interactiveLine = L.polyline(latlngs, {
          color: color,
          weight: Math.max(visibleWeight, 3),
          opacity: 0.8,
          interactive: true,
          featureRef: f
        }).addTo(networkLayerGroup);

        interactiveLine.on('mouseover', function() {
          interactiveLine.setStyle({
            weight: Math.max(visibleWeight + 2, 5),
            opacity: 1
          });
        });

        interactiveLine.on('mouseout', function() {
          interactiveLine.setStyle({
            weight: Math.max(visibleWeight, 3),
            opacity: 0.8
          });
        });

        interactiveLine.on('click', function(e) {
          console.log('Line clicked. OBJECTID:', f.properties?.OBJECTID);
          const popup = L.popup()
            .setLatLng(e.latlng)
            .setContent(createPopupContent(f))
            .openOn(map);
        });
        
        featuresDrawn++;
      });
    });

    console.log(`–û—Ç—Ä–∏—Å–æ–≤–∞–Ω–æ –ª–∏–Ω–∏–π: ${featuresDrawn}`);

    if (currentMapType === 'osm' || currentMapType === 'google_satellite') {
      setViewForTileMaps();
    } else if (currentMapType === 'custom' || currentMapType === 'custom2') {
      if (mapBounds) {
        setTimeout(() => {
          map.fitBounds(mapBounds);
          console.log('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã bounds –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–∞—Ä—Ç—ã:', mapBounds);
        }, 150);
      }
    }
  }

  // === –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ—á–µ–∫ ===
  function redrawPointsForCurrentCRS() {
    showLoadingModal();
    
    if (!allPointsGeoJson || !pointsLayerGroup) {
      console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫ –¥–ª—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏');
      hideLoadingModal();
      return;
    }

    console.log('–ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Ç–æ—á–µ–∫ –¥–ª—è —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã:', currentMapType);
    pointsLayerGroup.clearLayers();

    let pointsDrawn = 0;
    
    setTimeout(() => {
      try {
        allPointsGeoJson.features.forEach((feature, index) => {
          if (feature.geometry.type !== "Point") return;
          
          const name = feature.properties?.Name;
          const coords = feature.geometry.coordinates;
          
          if (!name || !coords?.[0] || !coords?.[1]) return;

          // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã
          const transformedCoords = transformPointCoords(coords, currentMapType);

          // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä —Å –∂–µ–ª—Ç—ã–º —Ü–≤–µ—Ç–æ–º –∏ —á–µ—Ä–Ω–æ–π –æ–±–≤–æ–¥–∫–æ–π
          const marker = L.circleMarker(transformedCoords, {
            radius: 3, // –£–º–µ–Ω—å—à–µ–Ω —Ä–∞–∑–º–µ—Ä
            fillColor: '#ff69b4', // –†–æ–∑–æ–≤—ã–π —Ü–≤–µ—Ç
            color: '#ff1493', //  –æ–±–≤–æ–¥–∫–∞
            weight: 1,
            opacity: 0.9,
            fillOpacity: 0.8
          }).addTo(pointsLayerGroup);

          // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å (—Ç–æ–ª—å–∫–æ –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã—Ö –∑—É–º–∞—Ö)
          const updateLabelVisibility = () => {
            const currentZoom = map.getZoom();
            const maxZoom = map.getMaxZoom();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥–ø–∏—Å–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã—Ö –∑—É–º–∞—Ö
            if (currentZoom >= maxZoom - 2) {
              if (!marker.getTooltip()) {
                marker.bindTooltip(name, {
                  permanent: true,
                  direction: 'top',
                  className: 'point-label'
                });
              }
            } else {
              if (marker.getTooltip()) {
                marker.unbindTooltip();
              }
            }
          };

          // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑—É–º–∞
          map.on('zoomend', updateLabelVisibility);
          
          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∏
          updateLabelVisibility();

          // –î–æ–±–∞–≤–ª—è–µ–º popup —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
          marker.bindPopup(`
            <div style="font-family: Calibri, Arial, sans-serif; font-size: 14px;">
              <strong>${name}</strong><br>
              –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${coords[0].toFixed(2)}, ${coords[1].toFixed(2)}
            </div>
          `);

          pointsDrawn++;
        });

        console.log(`–û—Ç—Ä–∏—Å–æ–≤–∞–Ω–æ —Ç–æ—á–µ–∫: ${pointsDrawn}`);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ —Ç–æ—á–µ–∫:', error);
      } finally {
        hideLoadingModal();
      }
    }, 100);
  }

  // === –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ—á–µ–∫ ===
  function togglePointsVisibility() {
    const pointsBtn = document.getElementById('points-toggle-btn');
    
    if (!pointsLayerGroup) {
      pointsLayerGroup = L.layerGroup().addTo(map);
    }

    if (pointsVisible) {
      // –°–∫—Ä—ã–≤–∞–µ–º —Ç–æ—á–∫–∏
      pointsLayerGroup.clearLayers();
      pointsBtn.classList.remove('active');
      pointsVisible = false;
      console.log('–¢–æ—á–∫–∏ —Å–∫—Ä—ã—Ç—ã');
    } else {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—á–∫–∏
      if (allPointsGeoJson) {
        redrawPointsForCurrentCRS();
        pointsBtn.classList.add('active');
        pointsVisible = true;
        console.log('–¢–æ—á–∫–∏ –ø–æ–∫–∞–∑–∞–Ω—ã');
      } else {
        console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
        hideLoadingModal();
      }
    }
  }

  function setViewForTileMaps() {
    if (!geoJsonData || geoJsonData.features.length === 0) {
      console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–∏–¥–∞');
      hideLoadingModal();
      return;
    }

    console.log('–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏–¥–∞ –¥–ª—è —Ç–∞–π–ª–æ–≤—ã—Ö –∫–∞—Ä—Ç');
    
    const allCoords = [];
    geoJsonData.features.forEach(f => {
      if (!f.geometry) return;
      
      let lines = [];
      if (f.geometry.type === 'LineString') lines = [f.geometry.coordinates];
      else if (f.geometry.type === 'MultiLineString') lines = f.geometry.coordinates;
      else return;

      lines.forEach(coords => {
        coords.forEach(pt => {
          const [lng, lat] = webMercatorToWGS84(pt[0], pt[1]);
          allCoords.push([lat, lng]);
        });
      });
    });

    if (allCoords.length === 0) {
      hideLoadingModal();
      return;
    }

    const group = new L.featureGroup();
    allCoords.forEach(coord => {
      group.addLayer(L.marker(coord));
    });

    map.fitBounds(group.getBounds(), { padding: [20, 20] });
    console.log('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤–∏–¥ –Ω–∞ bounds:', group.getBounds());
    
    hideLoadingModal();
  }

  // === –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å Firestore ===
  async function loadFirestoreData() {
    try {
      const snapshot = await db.collection('items').get();
      firestoreData.clear();
      snapshot.forEach(doc => {
        firestoreData.set(doc.id, doc.data());
      });
      console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π –∏–∑ Firestore:', firestoreData.size);
      return true;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firestore:', error);
      return false;
    }
  }

  async function updateWeightInFirestore(documentId, newWeight) {
    const user = auth.currentUser;
    
    if (!user || user.isAnonymous) {
      alert('–û—à–∏–±–∫–∞: –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã.');
      return false;
    }

    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    try {
      console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ID token...');
      await user.getIdToken(true); // true = force refresh
      console.log('‚úÖ ID token –æ–±–Ω–æ–≤–ª–µ–Ω');
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', error);
    }

    // –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
    await user.reload();
    const updatedUser = auth.currentUser;
    
    console.log('–°—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', {
      email: updatedUser.email,
      emailVerified: updatedUser.emailVerified
    });

    if (!updatedUser.emailVerified) {
      alert('–î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å email. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à—É –ø–æ—á—Ç—É –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.');
      return false;
    }

    try {
      const editorName = currentUserName || '–ê–Ω–æ–Ω–∏–º';
      
      const moscowTimestamp = getMoscowTimestamp();
      const moscowDateTime = getMoscowDateTime();
      
      console.log('–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ Firestore...');
      
      await db.collection('items').doc(documentId).update({
        weight: newWeight,
        editor_name: editorName,
        editor_email: currentUserEmail,
        editor_timestamp: moscowTimestamp,
        editor_datetime: moscowDateTime,
        last_modified: new Date().toISOString(),
        editor_verified: true
      });
      
      console.log('‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ Firestore');
      
      if (firestoreData.has(documentId)) {
        const data = firestoreData.get(documentId);
        data.weight = newWeight;
        data.editor_name = editorName;
        data.editor_email = currentUserEmail;
        data.editor_timestamp = moscowTimestamp;
        data.editor_datetime = moscowDateTime;
      }
      
      showSaveNotification();
      return true;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ Firestore:', error);
      
      if (error.code === 'permission-denied') {
        alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤. –¢–æ–∫–µ–Ω –Ω–µ –æ–±–Ω–æ–≤–∏–ª —Å—Ç–∞—Ç—É—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–π—Ç–∏ –∏ –∑–∞–π—Ç–∏ —Å–Ω–æ–≤–∞.');
      } else {
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
      }
      return false;
    }
  }

  async function updateCommentInFirestore(documentId, newComment) {
    const user = auth.currentUser;
    
    if (!user || user.isAnonymous) {
      alert('–û—à–∏–±–∫–∞: –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã.');
      return false;
    }

    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    try {
      console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ID token...');
      await user.getIdToken(true);
      console.log('‚úÖ ID token –æ–±–Ω–æ–≤–ª–µ–Ω');
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', error);
    }

    // –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
    await user.reload();
    const updatedUser = auth.currentUser;
    
    if (!updatedUser.emailVerified) {
      alert('–î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å email. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à—É –ø–æ—á—Ç—É –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.');
      return false;
    }

    try {
      const editorName = currentUserName || '–ê–Ω–æ–Ω–∏–º';
      
      const moscowTimestamp = getMoscowTimestamp();
      const moscowDateTime = getMoscowDateTime();
      
      await db.collection('items').doc(documentId).update({
        comment: newComment,
        comment_editor_name: editorName,
        comment_editor_email: currentUserEmail,
        comment_editor_timestamp: moscowTimestamp,
        comment_editor_datetime: moscowDateTime,
        last_modified: new Date().toISOString(),
        editor_verified: true
      });
      
      if (firestoreData.has(documentId)) {
        const data = firestoreData.get(documentId);
        data.comment = newComment;
        data.comment_editor_name = editorName;
        data.comment_editor_email = currentUserEmail;
        data.comment_editor_timestamp = moscowTimestamp;
        data.comment_editor_datetime = moscowDateTime;
      }
      
      return true;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –≤ Firestore:', error);
      
      if (error.code === 'permission-denied') {
        alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è.');
      } else {
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: ' + error.message);
      }
      return false;
    }
  }

  // === –§—É–Ω–∫—Ü–∏–∏ –∫–∞—Ä—Ç—ã ===
  function getRouteWeightByZoom(zoom) {
    return (zoom >= 4 && zoom <= 5) ? 6 : 3;
  }

  function getRouteColor(weight) {
    if (weight === 1 || weight === '1') return '#8B4513';
    if (weight === 2 || weight === '2') return '#ff0000';
    if (weight === 3 || weight === '3') return '#ff6700';
    if (weight === 4 || weight === '4') return '#0066ff';
    if (weight === 5 || weight === '5') return '#006400';
    return '#006400';
  }

  function getWeightName(weight) {
    const names = {
      1: '–ó–∞–≤–∞–ª',
      2: '–®–∫—É—Ä–æ–¥–µ—Ä', 
      3: '–ü—Ä–æ—Ö–æ–¥ —Å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ–º',
      4: '–û–±–≤–æ–¥–Ω–µ–Ω–Ω—ã–π —à—Ç—Ä–µ–∫',
      5: '–°–≤–æ–±–æ–¥–Ω—ã–π –ø—Ä–æ—Ö–æ–¥'
    };
    return names[weight] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
  }

  function showSaveNotification(message = '–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!') {
    const notification = document.getElementById('save-notification');
    notification.textContent = message;
    notification.style.display = 'block';
    setTimeout(() => {
      notification.style.display = 'none';
    }, 3000);
  }

  function createPopupContent(feature) {
    const div = document.createElement('div');
    div.className = 'popup-weight-selector';
    div.style.padding = '6px 0';
    
    const objectId = feature.properties?.OBJECTID;
    const currentWeight = feature.properties?.weight || 5;
    
    let documentId = null;
    let currentComment = '';
    let editorInfo = '';
    let commentEditorInfo = '';
    
    for (let [docId, data] of firestoreData) {
      if (data.fb_objectid == objectId) {
        documentId = docId;
        currentComment = data.comment || '';
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ—Ä–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ (—Ç–æ–ª—å–∫–æ –∏–º—è)
        if (data.editor_name) {
          editorInfo = `–ò–∑–º–µ–Ω–µ–Ω–æ: ${data.editor_name} ${data.editor_datetime || ''}`;
        }
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ—Ä–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è (—Ç–æ–ª—å–∫–æ –∏–º—è)
        if (data.comment_editor_name) {
          commentEditorInfo = `–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç: ${data.comment_editor_name} ${data.comment_editor_datetime || ''}`;
        }
        break;
      }
    }
    
    if (!canUserEdit()) {
      div.innerHTML = `
        <div style="margin-bottom: 8px; font-weight: bold; font-size: 14px;">
          OBJECTID: ${objectId || 'N/A'}<br>
          –°—Ç–∞—Ç—É—Å: ${getWeightName(currentWeight)}
        </div>
        ${editorInfo ? `<div style="font-size: 11px; color: #666; margin-bottom: 5px;">${editorInfo}</div>` : ''}
        ${currentComment ? `
          <div class="comment-section">
            <div class="comment-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</div>
            <div class="comment-text">${currentComment}</div>
            ${commentEditorInfo ? `<div style="font-size: 10px; color: #888; margin-top: 3px;">${commentEditorInfo}</div>` : ''}
          </div>
        ` : ''}
        <div style="font-size: 13px; color: #666; padding: 8px; background: #f5f5f5; border-radius: 4px;">
          ${currentUserRole === 'unverified' 
            ? 'üîí –î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∞—à email' 
            : 'üîí –î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É'}
        </div>
      `;
    } else {
      div.innerHTML = `
        <div style="margin-bottom: 8px; font-weight: bold; font-size: 14px;">
          OBJECTID: ${objectId || 'N/A'} | Document ID: ${documentId || 'N/A'}<br>
          –¢–µ–∫—É—â–∏–π: ${getWeightName(currentWeight)}
        </div>
        ${editorInfo ? `<div style="font-size: 11px; color: #666; margin-bottom: 5px;">${editorInfo}</div>` : ''}
        <div class="popup-option" data-weight="1">
          <div class="color-line" style="background-color: #8B4513;"></div>
          <span>–ó–∞–≤–∞–ª ${currentWeight === 1 ? '‚úì' : ''}</span>
        </div>
        <div class="popup-option" data-weight="2">
          <div class="color-line" style="background-color: #ff0000;"></div>
          <span>–®–∫—É—Ä–æ–¥–µ—Ä ${currentWeight === 2 ? '‚úì' : ''}</span>
        </div>
        <div class="popup-option" data-weight="3">
          <div class="color-line" style="background-color: #ff6700;"></div>
          <span>–ü—Ä–æ—Ö–æ–¥ —Å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ–º ${currentWeight === 3 ? '‚úì' : ''}</span>
        </div>
        <div class="popup-option" data-weight="4">
          <div class="color-line" style="background-color: #0066ff;"></div>
          <span>–û–±–≤–æ–¥–Ω–µ–Ω–Ω—ã–π —à—Ç—Ä–µ–∫ ${currentWeight === 4 ? '‚úì' : ''}</span>
        </div>
        <div class="popup-option" data-weight="5">
          <div class="color-line" style="background-color: #006400;"></div>
          <span>–°–≤–æ–±–æ–¥–Ω—ã–π –ø—Ä–æ—Ö–æ–¥ ${currentWeight === 5 ? '‚úì' : ''}</span>
        </div>
        <div class="comment-section">
          <div class="comment-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</div>
          ${currentComment ? `
            <div class="comment-text" id="comment-display">${currentComment}</div>
            ${commentEditorInfo ? `<div style="font-size: 10px; color: #888; margin-bottom: 3px;">${commentEditorInfo}</div>` : ''}
            <button class="comment-edit-btn" id="edit-comment-btn">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          ` : `
            <div class="no-comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</div>
            <button class="comment-edit-btn" id="edit-comment-btn">‚úèÔ∏è –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
          `}
          <div id="comment-edit-section" style="display: none;">
            <textarea class="comment-input" id="comment-input" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">${currentComment || ''}</textarea>
            <button class="comment-save-btn" id="save-comment-btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
          </div>
        </div>
      `;

      div.querySelectorAll('.popup-option').forEach(item => {
        item.addEventListener('click', async (e) => {
          e.stopPropagation();
          const newWeight = parseInt(item.dataset.weight, 10);
          
          if (documentId) {
            const success = await updateWeightInFirestore(documentId, newWeight);
            if (success) {
              console.log('Weight updated successfully');
              updateFeatureStyle(feature, newWeight);
              map.closePopup();
            } else {
              // –û—à–∏–±–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –≤ updateWeightInFirestore
            }
          } else {
            alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç –≤ –±–∞–∑–µ');
          }
        });
      });

      const editCommentBtn = div.querySelector('#edit-comment-btn');
      const commentEditSection = div.querySelector('#comment-edit-section');
      const saveCommentBtn = div.querySelector('#save-comment-btn');
      const commentInput = div.querySelector('#comment-input');

      editCommentBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        commentEditSection.style.display = 'block';
        editCommentBtn.style.display = 'none';
      });

      saveCommentBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const newComment = commentInput.value.trim();
        
        if (documentId) {
          const success = await updateCommentInFirestore(documentId, newComment);
          if (success) {
            console.log('Comment updated successfully');
            showSaveNotification('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
            
            const commentDisplay = div.querySelector('#comment-display');
            if (commentDisplay) {
              commentDisplay.textContent = newComment;
            } else {
              const commentSection = div.querySelector('.comment-section');
              const noCommentDiv = commentSection.querySelector('.no-comment');
              if (noCommentDiv) {
                noCommentDiv.style.display = 'none';
              }
              const newCommentDisplay = document.createElement('div');
              newCommentDisplay.className = 'comment-text';
              newCommentDisplay.id = 'comment-display';
              newCommentDisplay.textContent = newComment;
              commentSection.insertBefore(newCommentDisplay, editCommentBtn);
            }
            
            commentEditSection.style.display = 'none';
            editCommentBtn.style.display = 'block';
          } else {
            // –û—à–∏–±–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –≤ updateCommentInFirestore
          }
        } else {
          alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç –≤ –±–∞–∑–µ');
        }
      });
    }

    return div;
  }

  function updateFeatureStyle(feature, newWeight) {
    networkLayerGroup.eachLayer(layer => {
      if (layer.options?.featureRef === feature) {
        const currentZoom = map.getZoom();
        const baseWeight = Math.max(getRouteWeightByZoom(currentZoom), 3);
        
        layer.setStyle({ 
          color: getRouteColor(newWeight),
          weight: baseWeight,
          opacity: 0.8
        });
        
        layer.options.featureRef.properties.weight = newWeight;
      }
    });
  }

  async function loadGeoJson(url) {
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω GeoJSON –∏–∑ ${url}:`, data.features?.length, '—Ñ–∏—á');
      return data;
    } catch (e) {
      console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${url}:`, e);
      return { type: "FeatureCollection", features: [] };
    }
  }

  async function initializeMap() {
    showLoadingModal();
    
    try {
      geoJsonData = await loadGeoJson('data/routes.geojson');
      allPointsGeoJson = await loadGeoJson('data/points.geojson');
      
      const firestoreLoaded = await loadFirestoreData();
      if (!firestoreLoaded) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
        hideLoadingModal();
        return;
      }

      const mergedFeatures = geoJsonData.features.map(feature => {
        const objectId = feature.properties?.OBJECTID;
        let firestoreProps = null;
        for (let [docId, data] of firestoreData) {
          if (data.fb_objectid == objectId) {
            firestoreProps = data;
            break;
          }
        }
        if (firestoreProps) {
          return {
            ...feature,
            properties: {
              ...feature.properties,
              ...firestoreProps
            }
          };
        }
        return feature;
      });

      geoJsonData.features = mergedFeatures;

      const allCoords = [];
      mergedFeatures.forEach(f => {
        if (!f.geometry) return;
        let lines = [];
        if (f.geometry.type === 'LineString') lines = [f.geometry.coordinates];
        else if (f.geometry.type === 'MultiLineString') lines = f.geometry.coordinates;
        else return;

        lines.forEach(coords => {
          coords.forEach(pt => allCoords.push(pt));
        });
      });

      if (allCoords.length === 0) {
        hideLoadingModal();
        return;
      }

      const xs = allCoords.map(c => c[0]);
      const ys = allCoords.map(c => c[1]);
      
      mapBounds = [
        [Math.min(...ys), Math.min(...xs)],
        [Math.max(...ys), Math.max(...xs)]
      ];

      console.log('Bounds –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫–∞—Ä—Ç:', mapBounds);

      createTileLayer('custom');
      
      console.log('–ö–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –õ–∏–Ω–∏–π:', mergedFeatures.length);
      console.log('–¢–æ—á–µ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', allPointsGeoJson.features.length);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error);
      hideLoadingModal();
    }
  }

  // === –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ ===
  function updateUserVerificationStatus(user) {
    if (!user || user.isAnonymous) return;
    
    console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è:', user.email);
    console.log('–¢–µ–∫—É—â–∏–π emailVerified:', user.emailVerified);
    
    const userRoleElement = document.getElementById('user-role');
    const resendVerificationBtn = document.getElementById('resend-verification-btn');
    
    if (user.emailVerified) {
      currentUserRole = 'verified';
      const canExport = canUserExport();
      userRoleElement.textContent = canExport ? '—Ä–µ–¥–∞–∫—Ç–æ—Ä + —ç–∫—Å–ø–æ—Ä—Ç' : '—Ä–µ–¥–∞–∫—Ç–æ—Ä';
      
      // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
      if (resendVerificationBtn) {
        resendVerificationBtn.style.display = 'none';
      }
      
      console.log('‚úÖ –°—Ç–∞—Ç—É—Å –û–ë–ù–û–í–õ–ï–ù: verified');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è
      if (currentUserRole !== 'verified') {
        showSaveNotification('Email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã.');
      }
    } else {
      currentUserRole = 'unverified';
      userRoleElement.textContent = '—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email';
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
      if (resendVerificationBtn) {
        resendVerificationBtn.style.display = 'block';
      }
      
      console.log('‚ùå –°—Ç–∞—Ç—É—Å: unverified');
    }
    
    updateExportButtonState();
  }

  // === –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ ===
  async function sendEmailVerificationWithCheck(user) {
    try {
      console.log('üìß –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å—å–º–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è:', user.email);
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–∏—Å—å–º–æ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
      await user.sendEmailVerification();
      
      console.log('‚úÖ –ü–∏—Å—å–º–æ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
      return true;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏:', error);
      return false;
    }
  }

  // === –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π ===
  function setupAuth() {
    const authModal = document.getElementById('auth-modal');
    const userInfo = document.getElementById('user-info');
    const userEmail = document.getElementById('user-email');
    const userRole = document.getElementById('user-role');
    const logoutBtn = document.getElementById('logout-btn');
    const anonymousButton = document.getElementById('anonymous-button');
    const resendVerificationBtn = document.getElementById('resend-verification-btn');
    const reloadPageBtn = document.getElementById('reload-page-btn');
    
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const loginTab = document.querySelector('[data-tab="login"]');
    const registerTab = document.querySelector('[data-tab="register"]');
    const authMessage = document.getElementById('auth-message');

    loginTab.addEventListener('click', () => switchAuthTab('login'));
    registerTab.addEventListener('click', () => switchAuthTab('register'));

    function switchAuthTab(tab) {
      loginTab.classList.toggle('active', tab === 'login');
      registerTab.classList.toggle('active', tab === 'register');
      loginForm.classList.toggle('active', tab === 'login');
      registerForm.classList.toggle('active', tab === 'register');
      clearAuthMessage();
    }

    function clearAuthMessage() {
      authMessage.innerHTML = '';
      authMessage.className = 'auth-message';
    }

    function showAuthMessage(message, type) {
      authMessage.innerHTML = message;
      authMessage.className = `auth-message auth-${type}`;
    }

    const registerPassword = document.getElementById('register-password');
    const registerPasswordConfirm = document.getElementById('register-password-confirm');
    const passwordMatchMessage = document.getElementById('password-match-message');
    const registerButton = document.getElementById('register-button');

    function checkPasswordMatch() {
      const password = registerPassword.value;
      const confirmPassword = registerPasswordConfirm.value;
      
      if (password === '' || confirmPassword === '') {
        passwordMatchMessage.innerHTML = '';
        registerButton.disabled = true;
        return;
      }
      
      if (password === confirmPassword) {
        passwordMatchMessage.innerHTML = '‚úì –ü–∞—Ä–æ–ª–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
        passwordMatchMessage.className = 'password-match';
        registerButton.disabled = password.length < 6;
      } else {
        passwordMatchMessage.innerHTML = '‚úó –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
        passwordMatchMessage.className = 'password-mismatch';
        registerButton.disabled = true;
      }
    }

    registerPassword.addEventListener('input', checkPasswordMatch);
    registerPasswordConfirm.addEventListener('input', checkPasswordMatch);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—è –∏–º–µ–Ω–∏
    document.getElementById('register-name').addEventListener('input', function() {
      const name = this.value.trim();
      const registerButton = document.getElementById('register-button');
      const password = document.getElementById('register-password').value;
      const confirmPassword = document.getElementById('register-password-confirm').value;
      
      if (name === '') {
        registerButton.disabled = true;
      } else if (password === confirmPassword && password.length >= 6) {
        registerButton.disabled = false;
      }
    });

    document.getElementById('register-button').addEventListener('click', async () => {
      const name = document.getElementById('register-name').value.trim();
      const email = document.getElementById('register-email').value.trim();
      const password = document.getElementById('register-password').value;
      
      if (!name) {
        showAuthMessage('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ)', 'error');
        return;
      }
      
      if (!email) {
        showAuthMessage('–í–≤–µ–¥–∏—Ç–µ email', 'error');
        return;
      }
      
      if (password.length < 6) {
        showAuthMessage('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return;
      }

      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        await user.updateProfile({
          displayName: name
        });
        
        await user.sendEmailVerification();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        currentUserName = name;
        localStorage.setItem('editor_name', name);
        
        showAuthMessage(
          '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à—É –ø–æ—á—Ç—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email.',
          'success'
        );
        
        setTimeout(() => {
          switchAuthTab('login');
          document.getElementById('register-name').value = '';
          document.getElementById('register-email').value = '';
          document.getElementById('register-password').value = '';
          document.getElementById('register-password-confirm').value = '';
          passwordMatchMessage.innerHTML = '';
          registerButton.disabled = true;
        }, 3000);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
        let errorMessage = '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ';
        
        switch (error.code) {
          case 'auth/email-already-in-use':
            errorMessage += '–≠—Ç–æ—Ç email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
            break;
          case 'auth/invalid-email':
            errorMessage += '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email';
            break;
          case 'auth/weak-password':
            errorMessage += '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º —Å–ª–∞–±—ã–π';
            break;
          case 'auth/operation-not-allowed':
            errorMessage += '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ email –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
            break;
          default:
            errorMessage += error.message;
        }
        
        showAuthMessage(errorMessage, 'error');
      }
    });

    async function signInAnonymously() {
      try {
        await auth.signInAnonymously();
      } catch (error) {
        showAuthMessage('–û—à–∏–±–∫–∞ –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –≤—Ö–æ–¥–∞: ' + error.message, 'error');
      }
    }

    async function signInWithEmail() {
      const email = document.getElementById('auth-email').value;
      const password = document.getElementById('auth-password').value;
      
      if (!email || !password) {
        showAuthMessage('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å', 'error');
        return;
      }
      
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
        let errorMessage = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ';
        
        switch (error.code) {
          case 'auth/user-not-found':
            errorMessage += '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
            break;
          case 'auth/wrong-password':
            errorMessage += '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
            break;
          case 'auth/invalid-email':
            errorMessage += '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email';
            break;
          case 'auth/user-disabled':
            errorMessage += '–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω';
            break;
          default:
            errorMessage += error.message;
        }
        
        showAuthMessage(errorMessage, 'error');
      }
    }

    async function logout() {
      try {
        await auth.signOut();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:', error);
      }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
    resendVerificationBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (user && !user.emailVerified) {
        try {
          await sendEmailVerificationWithCheck(user);
          alert('–ü–∏—Å—å–º–æ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ ' + user.email);
        } catch (error) {
          alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message);
        }
      }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∑–∞—Ö–æ–¥–∞
    reloadPageBtn.addEventListener('click', () => {
      console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ–∑–∞—Ö–æ–¥...');
      location.reload();
    });

    anonymousButton.addEventListener('click', signInAnonymously);
    document.getElementById('auth-button').addEventListener('click', signInWithEmail);
    logoutBtn.addEventListener('click', logout);

    // === –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò ===
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        hideAuthModal();
        clearAuthMessage();
        
        console.log('=== –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ê–í–¢–û–†–ò–ó–û–í–ê–ù ===');
        console.log('Email:', user.email);
        console.log('Email Verified (–¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è):', user.emailVerified);
        console.log('Is Anonymous:', user.isAnonymous);
        
        // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –û–ë–ù–û–í–õ–Ø–ï–ú –î–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –î–õ–Ø –í–°–ï–• –ù–ï–ê–ù–û–ù–ò–ú–ù–´–•
        if (!user.isAnonymous) {
          try {
            console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
            await user.reload();
            const updatedUser = auth.currentUser;
            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
            console.log('Email Verified (–ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è):', updatedUser.emailVerified);
            user = updatedUser; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            
            // –ï—Å–ª–∏ email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω, –Ω–æ —Å—Ç–∞—Ç—É—Å –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è, –∂–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ—â–µ —Ä–∞–∑
            if (user.emailVerified && currentUserRole !== 'verified') {
              setTimeout(() => {
                updateUserVerificationStatus(user);
              }, 1000);
            }
          } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
          }
        }
        
        if (user.isAnonymous) {
          currentUserRole = 'anonymous';
          currentUserEmail = null;
          currentUserName = null;
          userEmail.textContent = '–ì–æ—Å—Ç—å';
          userRole.textContent = '—Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä';
        } else {
          currentUserEmail = user.email;
          currentUserName = user.displayName || user.email.split('@')[0];
          
          // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–º—è –∏ email –≤ —Å–∫–æ–±–∫–∞—Ö —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–∞–º–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          userEmail.textContent = `${currentUserName} (${user.email})`;
          
          // –û–ë–ù–û–í–õ–Ø–ï–ú –°–¢–ê–¢–£–° –í–ï–†–ò–§–ò–ö–ê–¶–ò–ò
          updateUserVerificationStatus(user);
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          if (!localStorage.getItem('editor_name')) {
            localStorage.setItem('editor_name', currentUserName);
          }
        }
        
        userInfo.style.display = 'flex';
        updateExportButtonState();
        initializeMap();
        
      } else {
        showAuthModal();
        userInfo.style.display = 'none';
        currentUserRole = 'anonymous';
        currentUserEmail = null;
        currentUserName = null;
        updateExportButtonState();
        
        // –û—á–∏—â–∞–µ–º –∫–∞—Ä—Ç—É
        if (networkLayerGroup) networkLayerGroup.clearLayers();
        if (pointsLayerGroup) pointsLayerGroup.clearLayers();
        if (currentImageOverlay) {
          map.removeLayer(currentImageOverlay);
          currentImageOverlay = null;
        }
        if (currentTileLayer) {
          map.removeLayer(currentTileLayer);
          currentTileLayer = null;
        }
      }
    });

    document.querySelectorAll('.auth-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        clearAuthMessage();
        document.getElementById('auth-email').value = '';
        document.getElementById('auth-password').value = '';
      });
    });
  }

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ===
  document.addEventListener('DOMContentLoaded', () => {
    map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: 0.05,
      maxZoom: 5,
      zoomControl: false,
      tap: false
    });

    networkLayerGroup = L.layerGroup().addTo(map);
    pointsLayerGroup = L.layerGroup().addTo(map);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –Ω–æ–≤–æ–º –±–ª–æ–∫–µ
    document.getElementById('zoom-in').addEventListener('click', () => {
      if (map.getZoom() < map.getMaxZoom()) map.zoomIn();
    });
    document.getElementById('zoom-out').addEventListener('click', () => {
      if (map.getZoom() > map.getMinZoom()) map.zoomOut();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ—á–µ–∫ –≤ –Ω–æ–≤–æ–º –±–ª–æ–∫–µ
    document.getElementById('points-toggle-btn').addEventListener('click', togglePointsVisibility);

    document.getElementById('background-select').addEventListener('change', function(e) {
      createTileLayer(e.target.value);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—Ç–∫–∞–∑–∞ –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
    document.getElementById('disclaimer-menu-btn').addEventListener('click', () => {
      document.getElementById('disclaimer-modal').classList.add('active');
      document.getElementById('dropdown-menu').classList.remove('active');
    });

    document.getElementById('disclaimer-close-btn').addEventListener('click', () => {
      document.getElementById('disclaimer-modal').classList.remove('active');
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.getElementById('disclaimer-modal').addEventListener('click', (e) => {
      if (e.target.id === 'disclaimer-modal') {
        document.getElementById('disclaimer-modal').classList.remove('active');
      }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.getElementById('auth-modal').addEventListener('click', (e) => {
      if (e.target.id === 'auth-modal') {
        // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–≥ –µ–≥–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      }
    });

    setupAuth();

    const menuButton = document.getElementById('menu-button');
    const dropdownMenu = document.getElementById('dropdown-menu');
    let menuOpen = false;
    menuButton.addEventListener('click', (e) => {
      e.stopPropagation();
      menuOpen = !menuOpen;
      dropdownMenu.classList.toggle('active', menuOpen);
    });
    document.addEventListener('click', () => {
      if (menuOpen) {
        menuOpen = false;
        dropdownMenu.classList.remove('active');
      }
    });
    dropdownMenu.addEventListener('click', (e) => e.stopPropagation());

    const legendBtn = document.getElementById('legend-btn');
    const legendPanel = document.getElementById('legend-panel');
    let legendOpen = false;
    legendBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      legendOpen = !legendOpen;
      legendPanel.style.display = legendOpen ? 'block' : 'none';
    });
    document.addEventListener('click', (e) => {
      if (legendOpen && !legendPanel.contains(e.target) && e.target !== legendBtn) {
        legendOpen = false;
        legendPanel.style.display = 'none';
      }
    });
    legendPanel.addEventListener('click', (e) => e.stopPropagation());

    const searchBtn = document.getElementById('search-btn');
    const searchInput = document.getElementById('search-input');
    const searchPanel = document.getElementById('search-panel');

    searchBtn.addEventListener('click', () => {
      const isVisible = searchPanel.style.display === 'block';
      searchPanel.style.display = isVisible ? 'none' : 'block';
      if (!isVisible) searchInput.focus();
    });

    searchInput.addEventListener('input', (e) => performSearch(e.target.value));
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        searchPanel.style.display = 'none';
        searchInput.value = '';
      }
    });

    document.addEventListener('click', (e) => {
      if (!searchPanel.contains(e.target) && e.target !== searchBtn) {
        searchPanel.style.display = 'none';
      }
    });

    document.getElementById('export-btn').addEventListener('click', () => {
      saveRoutesToFile();
    });
  });

  async function performSearch(query) {
    const resultsContainer = document.getElementById('search-results');
    resultsContainer.innerHTML = '';
    if (!query.trim() || !allPointsGeoJson) {
      resultsContainer.style.display = 'none';
      return;
    }

    const q = query.trim().toLowerCase();
    const matches = [];
    allPointsGeoJson.features.forEach(feature => {
      if (feature.geometry.type !== "Point") return;
      const name = feature.properties?.Name;
      const coords = feature.geometry.coordinates;
      if (!name || !coords?.[0] || !coords?.[1]) return;
      if (name.toLowerCase().includes(q)) {
        matches.push({ name, coords });
      }
    });

    if (matches.length === 0) {
      resultsContainer.style.display = 'none';
      return;
    }

    matches.sort((a, b) => a.name.localeCompare(b.name, 'ru'));
    matches.slice(0, 20).forEach(item => {
      const div = document.createElement('div');
      div.className = 'search-result-item';
      div.textContent = item.name;
      div.setAttribute('data-lng', item.coords[0]);
      div.setAttribute('data-lat', item.coords[1]);
      div.addEventListener('click', (e) => {
        const lng = parseFloat(e.target.getAttribute('data-lng'));
        const lat = parseFloat(e.target.getAttribute('data-lat'));
        if (!isNaN(lng) && !isNaN(lat)) {
          let targetLatLng;
          if (currentMapType === 'custom' || currentMapType === 'custom2') {
            targetLatLng = [lat, lng];
          } else {
            const [convertedLng, convertedLat] = webMercatorToWGS84(lng, lat);
            targetLatLng = [convertedLat, convertedLng];
          }
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑—É–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã
		  if (currentMapType === 'custom' || currentMapType === 'custom2') {
		    	// –î–ª—è –±—É–º–∞–∂–Ω—ã—Ö –∫–∞—Ä—Ç –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–Ω—å—à–∏–π –∑—É–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, 3)
			  map.setView(targetLatLng, 3);
		  } else {
			   // –î–ª—è OSM –∏ Google –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑—É–º
			 map.setView(targetLatLng, 20);
		  }
          // –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–¥–∏—É—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å 50 –¥–æ 10 –º–µ—Ç—Ä–æ–≤
          const highlight = L.circle(targetLatLng, {
            radius: 2, // –£–º–µ–Ω—å—à–µ–Ω–æ —Å 50 –¥–æ 2
            color: '#d32f2f',
            fillColor: '#ff6b6b',
            weight: 2,
            fillOpacity: 0.5
          }).addTo(map);
          setTimeout(() => map.removeLayer(highlight), 3000);
          document.getElementById('search-panel').style.display = 'none';
          document.getElementById('search-input').value = '';
        }
      });
      resultsContainer.appendChild(div);
    });
    resultsContainer.style.display = 'block';
  }
</script>
</body>
</html>


