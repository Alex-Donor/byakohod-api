<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ë—è–∫–æ–•–æ–¥ ‚Äî –æ—Ü–∏—Ñ—Ä–æ–≤–∫–∞</title>
  <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- –î–æ–±–∞–≤–ª—è–µ–º Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Calibri, Arial, sans-serif;
      overflow: hidden;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    #map {
      width: 100%;
      height: 100vh;
    }
    #menu-button {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 40px;
      height: 40px;
      background: white;
      border: 2px solid #ccc;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      z-index: 1001;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
    }
    #menu-button span {
      display: block;
      width: 4px;
      height: 4px;
      background: #333;
      border-radius: 50%;
      margin: 1px 0;
    }
    #dropdown-menu {
      display: none;
      position: absolute;
      top: 55px;
      left: 10px;
      background: #e8e8e8;
      padding: 16px 12px;
      border-radius: 8px;
      box-shadow: 0 0 12px rgba(0,0,0,0.5);
      z-index: 1000;
      font-size: 14px;
      font-family: Calibri, Arial, sans-serif;
    }
    #dropdown-menu.active {
      display: block;
    }
    .menu-section {
      margin-bottom: 12px;
    }
    .menu-label {
      display: block;
      font-weight: bold;
      color: #222;
      margin-bottom: 6px;
    }
    select {
      width: 200px;
      padding: 6px;
      font-size: 14px;
      border: 1px solid #999;
      border-radius: 4px;
      background: white;
      font-family: Calibri, Arial, sans-serif;
    }
    #search-btn,
    #legend-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 40px;
      height: 40px;
      background: white;
      border: 2px solid #ccc;
      border-radius: 6px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      font-size: 20px;
      color: #333;
      z-index: 1002;
    }
    #legend-btn {
      right: 58px;
    }
    #search-panel,
    #legend-panel {
      position: absolute;
      top: 58px;
      right: 12px;
      width: 220px;
      display: none;
      z-index: 1003;
      background: white;
      padding: 12px;
      border: 2px solid #aaa;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      font-family: Calibri, Arial, sans-serif;
      font-size: 14px;
    }
    #legend-panel {
      right: 58px;
      width: 200px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin: 6px 0;
    }
    .legend-color {
      width: 20px;
      height: 4px;
      margin-right: 8px;
      border-radius: 2px;
    }
    #search-input {
      width: 100%;
      padding: 8px 12px;
      border: 2px solid #aaa;
      border-radius: 4px;
      font-size: 14px;
      font-family: Calibri, Arial, sans-serif;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    #search-results {
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border: 2px solid #aaa;
      border-top: none;
      border-radius: 0 0 6px 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: none;
    }
    .search-result-item {
      padding: 6px 12px;
      cursor: pointer;
      font-size: 14px;
      font-family: Calibri, Arial, sans-serif;
      border-bottom: 1px solid #eee;
    }
    .search-result-item:hover {
      background-color: #f0f8ff;
    }

    #zoom-and-copyright {
      position: absolute;
      top: 12px;
      left: 60px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1000;
    }

    .zoom-btn {
      width: 30px;
      height: 30px;
      background: white;
      border: 2px solid rgba(0,0,0,0.2);
      border-radius: 4px;
      font-weight: bold;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    }
    .zoom-btn:hover {
      background: #f0f0f0;
    }

    #copyright {
      font-size: 13px;
      white-space: nowrap;
      font-weight: bold;
      text-shadow:
        -1px -1px 0 white,
         1px -1px 0 white,
        -1px  1px 0 white,
         1px  1px 0 white;
    }
    #copyright a {
      text-decoration: none;
      color: #0066cc;
    }

    .leaflet-control-attribution {
      display: none !important;
    }

    .popup-option {
      display: flex;
      align-items: center;
      padding: 6px 10px;
      margin: 4px 0;
      cursor: pointer;
      border-radius: 4px;
      font-family: Calibri, Arial, sans-serif;
      font-size: 14px;
    }
    .popup-option:hover {
      background-color: #f0f8ff;
    }
    .color-line {
      width: 30px;
      height: 4px;
      margin-right: 10px;
      border-radius: 2px;
    }

    .save-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      z-index: 10000;
      font-family: Calibri, Arial, sans-serif;
      display: none;
    }

    .export-btn {
      position: absolute;
      top: 12px;
      right: 104px;
      width: 40px;
      height: 40px;
      background: white;
      border: 2px solid #ccc;
      border-radius: 6px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      font-size: 20px;
      color: #333;
      z-index: 1002;
    }

    .export-btn.disabled {
      background: #cccccc !important;
      cursor: not-allowed !important;
      opacity: 0.6;
    }

    .export-btn.disabled:hover {
      background: #cccccc !important;
    }

    .export-tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 10000;
      pointer-events: none;
    }

    #auth-panel {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      z-index: 10000;
      text-align: center;
      width: 300px;
    }

    #auth-email, #auth-password {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: Calibri, Arial, sans-serif;
      box-sizing: border-box;
    }

    #auth-button {
      width: 100%;
      padding: 10px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: Calibri, Arial, sans-serif;
      margin-top: 10px;
    }

    #auth-button:hover {
      background: #0055aa;
    }

    #anonymous-button {
      width: 100%;
      padding: 10px;
      background: #666;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: Calibri, Arial, sans-serif;
      margin-top: 8px;
    }

    #anonymous-button:hover {
      background: #555;
    }

    .auth-divider {
      margin: 15px 0;
      border-top: 1px solid #ddd;
      position: relative;
    }

    .auth-divider-text {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 0 10px;
      color: #666;
      font-size: 12px;
    }

    #user-info {
      position: absolute;
      top: 12px;
      right: 150px;
      background: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      border: 1px solid #ccc;
      z-index: 1002;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #logout-btn {
      background: #ff4444;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 11px;
      font-family: Calibri, Arial, sans-serif;
    }

    #logout-btn:hover {
      background: #cc0000;
    }

    .user-role-badge {
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      color: #666;
    }

    .auth-tabs {
      display: flex;
      margin-bottom: 15px;
      border-bottom: 1px solid #ddd;
    }

    .auth-tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      border: none;
      background: none;
      font-family: Calibri, Arial, sans-serif;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    .auth-tab.active {
      background: #0066cc;
      color: white;
      border-radius: 4px 4px 0 0;
    }

    .auth-tab:hover:not(.active) {
      background: #f0f0f0;
    }

    .auth-form {
      display: none;
    }

    .auth-form.active {
      display: block;
    }

    #register-name,
    #register-email,
    #register-password,
    #register-password-confirm {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: Calibri, Arial, sans-serif;
      box-sizing: border-box;
    }

    .password-match {
      color: #4CAF50;
      font-size: 12px;
      margin-top: -5px;
      margin-bottom: 10px;
    }

    .password-mismatch {
      color: #f44336;
      font-size: 12px;
      margin-top: -5px;
      margin-bottom: 10px;
    }

    #register-button {
      width: 100%;
      padding: 10px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: Calibri, Arial, sans-serif;
      margin-top: 10px;
    }

    #register-button:hover {
      background: #45a049;
    }

    #register-button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }

    .auth-message {
      margin-top: 10px;
      padding: 8px;
      border-radius: 4px;
      font-size: 12px;
      text-align: center;
    }

    .auth-success {
      background: #dff0d8;
      color: #3c763d;
      border: 1px solid #d6e9c6;
    }

    .auth-error {
      background: #f2dede;
      color: #a94442;
      border: 1px solid #ebccd1;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ */
    .comment-section {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #ddd;
    }

    .comment-label {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 12px;
    }

    .comment-text {
      font-size: 11px;
      color: #666;
      margin-bottom: 5px;
      word-break: break-word;
    }

    .comment-input {
      width: 100%;
      padding: 6px;
      font-size: 12px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-family: Calibri, Arial, sans-serif;
      box-sizing: border-box;
    }

    .comment-save-btn {
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 11px;
      font-family: Calibri, Arial, sans-serif;
      margin-top: 5px;
    }

    .comment-save-btn:hover {
      background: #45a049;
    }

    .comment-edit-btn {
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 10px;
      font-family: Calibri, Arial, sans-serif;
      margin-top: 3px;
    }

    .comment-edit-btn:hover {
      background: #0b7dda;
    }

    .no-comment {
      font-style: italic;
      color: #999;
      font-size: 11px;
    }
  </style>
</head>
<body>
<div id="menu-button">
  <span></span>
  <span></span>
  <span></span>
</div>

<div id="zoom-and-copyright">
  <div class="zoom-btn" id="zoom-in">+</div>
  <div class="zoom-btn" id="zoom-out">‚àí</div>
  <div id="copyright">
    <a href="https://t.me/Aleks_Donor" target="_blank" rel="noopener">¬© by Alex Donor</a>
  </div>
</div>

<div id="dropdown-menu">
  <div class="menu-section">
    <span class="menu-label">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É:</span>
    <select id="background-select">
      <option value="custom">–ë–∞–∑–æ–≤–∞—è –∫–∞—Ä—Ç–∞</option>
      <option value="custom2">–ö–∞—Ä—Ç–∞ —Å –∑–∞–ª–∏–≤–∫–æ–π</option>
      <option value="osm">OpenStreetMap</option>
      <option value="google_satellite">Google Satellite</option>
    </select>
  </div>
</div>

<button id="legend-btn">üõà</button>
<button id="search-btn">üîç</button>
<button class="export-btn" id="export-btn" title="–≠–∫—Å–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç–æ–≤">üíæ</button>
<div id="user-info" style="display: none;">
  <span id="user-email"></span>
  <span id="user-role" class="user-role-badge"></span>
  <button id="logout-btn">–í—ã–π—Ç–∏</button>
</div>

<div id="legend-panel">
  <div class="legend-item">
    <div class="legend-color" style="background-color: #8B4513;"></div>
    <span>–ó–∞–≤–∞–ª (1)</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background-color: #ff0000;"></div>
    <span>–®–∫—É—Ä–æ–¥–µ—Ä (2)</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background-color: #ff6700;"></div>
    <span>–ü—Ä–æ—Ö–æ–¥ —Å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ–º (3)</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background-color: #0066ff;"></div>
    <span>–û–±–≤–æ–¥–Ω–µ–Ω–Ω—ã–π —à—Ç—Ä–µ–∫ (4)</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background-color: #006400;"></div>
    <span>–°–≤–æ–±–æ–¥–Ω—ã–π –ø—Ä–æ—Ö–æ–¥ (5)</span>
  </div>
</div>

<div id="search-panel">
  <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ —Ç–æ—á–µ–∫...">
  <div id="search-results"></div>
</div>

<div id="map"></div>

<div id="save-notification" class="save-notification">–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</div>

<!-- –ü–∞–Ω–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π -->
<div id="auth-panel" style="display: none;">
  <div class="auth-tabs">
    <button class="auth-tab active" data-tab="login">–í—Ö–æ–¥</button>
    <button class="auth-tab" data-tab="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
  </div>

  <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
  <div id="login-form" class="auth-form active">
    <h3>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
    <input type="email" id="auth-email" placeholder="Email">
    <input type="password" id="auth-password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button id="auth-button">–í–æ–π—Ç–∏</button>
    
    <div class="auth-divider">
      <div class="auth-divider-text">–∏–ª–∏</div>
    </div>
    
    <button id="anonymous-button">–í–æ–π—Ç–∏ –∫–∞–∫ –≥–æ—Å—Ç—å</button>
    <div style="margin-top: 15px; font-size: 12px; color: #666;">
      <strong>–ì–æ—Å—Ç—å:</strong> –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ä—Ç—ã –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    </div>
  </div>

  <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
  <div id="register-form" class="auth-form">
    <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
    <input type="text" id="register-name" placeholder="–í–∞—à–µ –∏–º—è">
    <input type="email" id="register-email" placeholder="Email">
    <input type="password" id="register-password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)">
    <input type="password" id="register-password-confirm" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
    <div id="password-match-message"></div>
    <button id="register-button" disabled>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    
    <div style="margin-top: 15px; font-size: 11px; color: #666; text-align: center;">
      –ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à—É –ø–æ—á—Ç—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email
    </div>
  </div>

  <div id="auth-message"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // === Firebase Configuration ===
  const firebaseConfig = {
    apiKey: "AIzaSyAFFLaRyH4CoEWd8lZqW7aRWwOp3OkfI0Y",
    authDomain: "byakitb.firebaseapp.com",
    projectId: "byakitb",
    storageBucket: "byakitb.firebasestorage.app",
    messagingSenderId: "39005850684",
    appId: "1:39005850684:web:f6e5b4904482af3cc9c739"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  // === –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ===
  let map;
  let currentImageOverlay = null;
  let currentTileLayer = null;
  let mapBounds = null;
  let networkLayerGroup;
  let allPointsGeoJson = null;
  let geoJsonData = null;
  let firestoreData = new Map();
  let currentUserRole = 'anonymous';
  let currentMapType = 'custom';
  let currentUserEmail = null;

  // === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ú–æ—Å–∫–æ–≤—Å–∫–∏–º –≤—Ä–µ–º–µ–Ω–µ–º ===
  function getMoscowTimestamp() {
    // –ü—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è - –æ–Ω–æ —É–∂–µ –≤ –ú–æ—Å–∫–æ–≤—Å–∫–æ–º –≤—Ä–µ–º–µ–Ω–∏ (UTC+3)
    return firebase.firestore.Timestamp.fromDate(new Date());
  }

  function formatMoscowDateTime(date) {
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ dd.mm.yyyy hh:mm
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
	  
    return `${day}.${month}.${year} ${hours}:${minutes}`;
  }

  function getMoscowDateTime() {
    // –ü—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
    return formatMoscowDateTime(new Date());
  }

  // === –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —ç–∫—Å–ø–æ—Ä—Ç—É ===
  function canUserExport() {
    return currentUserEmail === 'bognachev@mail.ru';
  }

  // === –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ ===
  function updateExportButtonState() {
    const exportBtn = document.getElementById('export-btn');
    const canExport = canUserExport();
    
    if (canExport) {
      exportBtn.classList.remove('disabled');
      exportBtn.title = '–≠–∫—Å–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç–æ–≤ –≤ GeoJSON';
    } else {
      exportBtn.classList.add('disabled');
      if (currentUserEmail) {
        exportBtn.title = '–≠–∫—Å–ø–æ—Ä—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è bognachev@mail.ru';
      } else {
        exportBtn.title = '–î–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É';
      }
    }
  }

  // === –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏ ===
  function showTooltip(message, element) {
    const tooltip = document.createElement('div');
    tooltip.className = 'export-tooltip';
    tooltip.textContent = message;
    
    const rect = element.getBoundingClientRect();
    tooltip.style.left = (rect.left + window.pageXOffset) + 'px';
    tooltip.style.top = (rect.top + window.pageYOffset - 30) + 'px';
    
    document.body.appendChild(tooltip);
    
    setTimeout(() => {
      if (tooltip.parentNode) {
        tooltip.parentNode.removeChild(tooltip);
      }
    }, 2000);
  }

  // === –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ ===
  async function saveRoutesToFile() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
    if (!canUserExport()) {
      const exportBtn = document.getElementById('export-btn');
      if (currentUserEmail) {
        showTooltip('–≠–∫—Å–ø–æ—Ä—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è bognachev@mail.ru', exportBtn);
      } else {
        showTooltip('–î–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', exportBtn);
      }
      return false;
    }

    try {
      const routesToSave = { 
        type: "FeatureCollection", 
        features: [],
        metadata: {
          exported_by: currentUserEmail,
          export_date: new Date().toISOString(),
          firebase_data: true
        }
      };

      // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Firestore –∏ –æ–±—ä–µ–¥–∏–Ω—è–µ–º —Å –≥–µ–æ–º–µ—Ç—Ä–∏–µ–π –∏–∑ GeoJSON
      const seen = new Set();
      
      geoJsonData.features.forEach(feature => {
        const objectId = feature.properties?.OBJECTID;
        
        // –ò—â–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ Firestore
        let firestoreDataForFeature = null;
        for (let [docId, data] of firestoreData) {
          if (data.fb_objectid == objectId) {
            firestoreDataForFeature = data;
            break;
          }
        }

        // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π feature
        const mergedFeature = {
          ...feature,
          properties: {
            ...feature.properties,
            ...firestoreDataForFeature
          }
        };

        if (!seen.has(objectId)) {
          seen.add(objectId);
          routesToSave.features.push(mergedFeature);
        }
      });

      routesToSave.metadata.total_features = routesToSave.features.length;
      routesToSave.metadata.firestore_records = firestoreData.size;

      console.log('–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö:', {
        features: routesToSave.features.length,
        firestoreRecords: firestoreData.size,
        exportedBy: currentUserEmail
      });

      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(routesToSave, null, 2));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", `routes_export_${new Date().toISOString().slice(0, 10)}_${currentUserEmail.split('@')[0]}.geojson`);
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
      
      console.log('–ú–∞—Ä—à—Ä—É—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ —Ñ–∞–π–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º:', currentUserEmail);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —ç–∫—Å–ø–æ—Ä—Ç–µ
      showSaveNotification('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ GeoJSON!');
      return true;
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
      return false;
    }
  }

  // === –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç ===
  function webMercatorToWGS84(x, y) {
    if (Math.abs(x) < 180 && Math.abs(y) < 90) {
      return [x, y];
    }
    
    const earthRadius = 6378137;
    const halfCircumference = Math.PI * earthRadius;
    
    const lon = (x / halfCircumference) * 180;
    let lat = (y / halfCircumference) * 180;
    lat = 180 / Math.PI * (2 * Math.atan(Math.exp(lat * Math.PI / 180)) - Math.PI / 2);
    
    return [lon, lat];
  }

  function transformCoordsForTileMaps(coords) {
    return coords.map(pt => {
      let x = pt[0], y = pt[1];
      
      if (Math.abs(x) > 180 || Math.abs(y) > 90) {
        [x, y] = webMercatorToWGS84(x, y);
      }
      
      return [y, x];
    });
  }

  function transformCoordsForCustomMaps(coords) {
    return coords.map(pt => [pt[1], pt[0]]);
  }

  // === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–¥–ª–æ–∂–∫–∞–º–∏ ===
  function createTileLayer(type) {
    currentMapType = type;
    
    console.log('–°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ—è:', type);
    
    if (currentImageOverlay) {
      map.removeLayer(currentImageOverlay);
      currentImageOverlay = null;
    }
    if (currentTileLayer) {
      map.removeLayer(currentTileLayer);
      currentTileLayer = null;
    }

    switch(type) {
      case 'custom':
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–∞—Ä—Ç—ã');
        map.options.crs = L.CRS.Simple;
        map.setMinZoom(0.05);
        map.setMaxZoom(5);
        
        if (mapBounds) {
          currentImageOverlay = L.imageOverlay('maps/byaki.png', mapBounds, { opacity: 1 }).addTo(map);
          setTimeout(() => {
            map.fitBounds(mapBounds);
          }, 100);
        }
        break;
      
      case 'custom2':
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–∞—Ä—Ç—ã 2');
        map.options.crs = L.CRS.Simple;
        map.setMinZoom(0.05);
        map.setMaxZoom(5);
        
        if (mapBounds) {
          currentImageOverlay = L.imageOverlay('maps/map2.png', mapBounds, { opacity: 1 }).addTo(map);
          setTimeout(() => {
            map.fitBounds(mapBounds);
          }, 100);
        }
        break;
      
      case 'osm':
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ OSM');
        map.options.crs = L.CRS.EPSG3857;
        map.setMinZoom(0);
        map.setMaxZoom(20);
        
        currentTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors',
          maxZoom: 20
        }).addTo(map);
        break;
      
      case 'google_satellite':
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ Google Satellite');
        map.options.crs = L.CRS.EPSG3857;
        map.setMinZoom(0);
        map.setMaxZoom(20);
        
        currentTileLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
          attribution: '¬© Google',
          maxZoom: 20
        }).addTo(map);
        break;
    }

    redrawGeometryForCurrentCRS();
  }

  function redrawGeometryForCurrentCRS() {
    if (!geoJsonData || !networkLayerGroup) {
      console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏');
      return;
    }

    console.log('–ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –≥–µ–æ–º–µ—Ç—Ä–∏–∏ –¥–ª—è —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã:', currentMapType);
    networkLayerGroup.clearLayers();

    const transformFunction = (currentMapType === 'custom' || currentMapType === 'custom2') 
      ? transformCoordsForCustomMaps 
      : transformCoordsForTileMaps;

    let featuresDrawn = 0;
    
    geoJsonData.features.forEach((f, index) => {
      if (!f.geometry) return;
      
      let lines = [];
      if (f.geometry.type === 'LineString') lines = [f.geometry.coordinates];
      else if (f.geometry.type === 'MultiLineString') lines = f.geometry.coordinates;
      else return;

      const weight = f.properties?.weight || 5; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–≤–æ–±–æ–¥–Ω—ã–π –ø—Ä–æ—Ö–æ–¥ (5)
      const color = getRouteColor(weight);
      const visibleWeight = getRouteWeightByZoom(map.getZoom());

      lines.forEach((coords, lineIndex) => {
        if (coords.length < 2) return;
        
        const latlngs = transformFunction(coords);

        const interactiveLine = L.polyline(latlngs, {
          color: color,
          weight: Math.max(visibleWeight, 3),
          opacity: 0.8,
          interactive: true,
          featureRef: f
        }).addTo(networkLayerGroup);

        interactiveLine.on('mouseover', function() {
          interactiveLine.setStyle({
            weight: Math.max(visibleWeight + 2, 5),
            opacity: 1
          });
        });

        interactiveLine.on('mouseout', function() {
          interactiveLine.setStyle({
            weight: Math.max(visibleWeight, 3),
            opacity: 0.8
          });
        });

        interactiveLine.on('click', function(e) {
          console.log('Line clicked. OBJECTID:', f.properties?.OBJECTID);
          const popup = L.popup()
            .setLatLng(e.latlng)
            .setContent(createPopupContent(f))
            .openOn(map);
        });
        
        featuresDrawn++;
      });
    });

    console.log(`–û—Ç—Ä–∏—Å–æ–≤–∞–Ω–æ –ª–∏–Ω–∏–π: ${featuresDrawn}`);

    if (currentMapType === 'osm' || currentMapType === 'google_satellite') {
      setViewForTileMaps();
    } else if (currentMapType === 'custom' || currentMapType === 'custom2') {
      if (mapBounds) {
        setTimeout(() => {
          map.fitBounds(mapBounds);
          console.log('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã bounds –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–∞—Ä—Ç—ã:', mapBounds);
        }, 150);
      }
    }
  }

  function setViewForTileMaps() {
    if (!geoJsonData || geoJsonData.features.length === 0) {
      console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–∏–¥–∞');
      return;
    }

    console.log('–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏–¥–∞ –¥–ª—è —Ç–∞–π–ª–æ–≤—ã—Ö –∫–∞—Ä—Ç');
    
    const allCoords = [];
    geoJsonData.features.forEach(f => {
      if (!f.geometry) return;
      
      let lines = [];
      if (f.geometry.type === 'LineString') lines = [f.geometry.coordinates];
      else if (f.geometry.type === 'MultiLineString') lines = f.geometry.coordinates;
      else return;

      lines.forEach(coords => {
        coords.forEach(pt => {
          const [lng, lat] = webMercatorToWGS84(pt[0], pt[1]);
          allCoords.push([lat, lng]);
        });
      });
    });

    if (allCoords.length === 0) return;

    const group = new L.featureGroup();
    allCoords.forEach(coord => {
      group.addLayer(L.marker(coord));
    });

    map.fitBounds(group.getBounds(), { padding: [20, 20] });
    console.log('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤–∏–¥ –Ω–∞ bounds:', group.getBounds());
  }

  // === –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å Firestore ===
  async function loadFirestoreData() {
    try {
      const snapshot = await db.collection('items').get();
      firestoreData.clear();
      snapshot.forEach(doc => {
        firestoreData.set(doc.id, doc.data());
      });
      console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π –∏–∑ Firestore:', firestoreData.size);
      return true;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firestore:', error);
      return false;
    }
  }

  async function updateWeightInFirestore(documentId, newWeight) {
    if (currentUserRole === 'anonymous') {
      alert('–ì–æ—Å—Ç–∏ –Ω–µ –º–æ–≥—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã. –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.');
      return false;
    }

    try {
      const editorName = localStorage.getItem('editor_name') || '–ê–Ω–æ–Ω–∏–º';
      
      // –ü–æ–ª—É—á–∞–µ–º –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
      const moscowTimestamp = getMoscowTimestamp(); // Timestamp –¥–ª—è editor_timestamp
      const moscowDateTime = getMoscowDateTime();   // –°—Ç—Ä–æ–∫–∞ –¥–ª—è editor_datetime
      
      console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏:', {
        timestamp: moscowTimestamp,
        datetime: moscowDateTime,
        documentId: documentId
      });
      
      await db.collection('items').doc(documentId).update({
        weight: newWeight,
        editor_name: editorName,
        editor_timestamp: moscowTimestamp,  // Firestore Timestamp
        editor_datetime: moscowDateTime     // –°—Ç—Ä–æ–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ dd.mm.yyyy hh:mm
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      if (firestoreData.has(documentId)) {
        const data = firestoreData.get(documentId);
        data.weight = newWeight;
        data.editor_name = editorName;
        data.editor_timestamp = moscowTimestamp;
        data.editor_datetime = moscowDateTime;
      }
      
      return true;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ Firestore:', error);
      return false;
    }
  }

  // === –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –≤ Firestore ===
  async function updateCommentInFirestore(documentId, newComment) {
    if (currentUserRole === 'anonymous') {
      alert('–ì–æ—Å—Ç–∏ –Ω–µ –º–æ–≥—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏. –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.');
      return false;
    }

    try {
      const editorName = localStorage.getItem('editor_name') || '–ê–Ω–æ–Ω–∏–º';
      
      // –ü–æ–ª—É—á–∞–µ–º –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
      const moscowTimestamp = getMoscowTimestamp();
      const moscowDateTime = getMoscowDateTime();
      
      console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', {
        documentId: documentId,
        comment: newComment,
        editor: editorName
      });
      
      await db.collection('items').doc(documentId).update({
        comment: newComment,
        comment_editor_name: editorName,
        comment_editor_timestamp: moscowTimestamp,
        comment_editor_datetime: moscowDateTime
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      if (firestoreData.has(documentId)) {
        const data = firestoreData.get(documentId);
        data.comment = newComment;
        data.comment_editor_name = editorName;
        data.comment_editor_timestamp = moscowTimestamp;
        data.comment_editor_datetime = moscowDateTime;
      }
      
      return true;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –≤ Firestore:', error);
      return false;
    }
  }

  // === –§—É–Ω–∫—Ü–∏–∏ –∫–∞—Ä—Ç—ã ===
  function getRouteWeightByZoom(zoom) {
    return (zoom >= 4 && zoom <= 5) ? 6 : 3;
  }

  function getRouteColor(weight) {
    if (weight === 1 || weight === '1') return '#8B4513';     // –ó–∞–≤–∞–ª
    if (weight === 2 || weight === '2') return '#ff0000';     // –®–∫—É—Ä–æ–¥–µ—Ä
    if (weight === 3 || weight === '3') return '#ff6700';     // –ü—Ä–æ—Ö–æ–¥ —Å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ–º
    if (weight === 4 || weight === '4') return '#0066ff';     // –û–±–≤–æ–¥–Ω–µ–Ω–Ω—ã–π —à—Ç—Ä–µ–∫
    if (weight === 5 || weight === '5') return '#006400';     // –°–≤–æ–±–æ–¥–Ω—ã–π –ø—Ä–æ—Ö–æ–¥
    return '#006400'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–≤–æ–±–æ–¥–Ω—ã–π –ø—Ä–æ—Ö–æ–¥
  }

  function getWeightName(weight) {
    const names = {
      1: '–ó–∞–≤–∞–ª',
      2: '–®–∫—É—Ä–æ–¥–µ—Ä', 
      3: '–ü—Ä–æ—Ö–æ–¥ —Å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ–º',
      4: '–û–±–≤–æ–¥–Ω–µ–Ω–Ω—ã–π —à—Ç—Ä–µ–∫',
      5: '–°–≤–æ–±–æ–¥–Ω—ã–π –ø—Ä–æ—Ö–æ–¥'
    };
    return names[weight] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
  }

  function showSaveNotification(message = '–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!') {
    const notification = document.getElementById('save-notification');
    notification.textContent = message;
    notification.style.display = 'block';
    setTimeout(() => {
      notification.style.display = 'none';
    }, 3000);
  }

  function createPopupContent(feature) {
    const div = document.createElement('div');
    div.className = 'popup-weight-selector';
    div.style.padding = '6px 0';
    
    const objectId = feature.properties?.OBJECTID;
    const currentWeight = feature.properties?.weight || 5; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–≤–æ–±–æ–¥–Ω—ã–π –ø—Ä–æ—Ö–æ–¥
    
    let documentId = null;
    let currentComment = '';
    for (let [docId, data] of firestoreData) {
      if (data.fb_objectid == objectId) {
        documentId = docId;
        currentComment = data.comment || '';
        break;
      }
    }
    
    if (currentUserRole === 'anonymous') {
      div.innerHTML = `
        <div style="margin-bottom: 8px; font-weight: bold; font-size: 12px;">
          OBJECTID: ${objectId || 'N/A'}<br>
          –°—Ç–∞—Ç—É—Å: ${getWeightName(currentWeight)}
        </div>
        ${currentComment ? `
          <div class="comment-section">
            <div class="comment-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</div>
            <div class="comment-text">${currentComment}</div>
          </div>
        ` : ''}
        <div style="font-size: 11px; color: #666; padding: 8px; background: #f5f5f5; border-radius: 4px;">
          üîí –î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É
        </div>
      `;
    } else {
      div.innerHTML = `
        <div style="margin-bottom: 8px; font-weight: bold; font-size: 12px;">
          OBJECTID: ${objectId || 'N/A'} | Document ID: ${documentId || 'N/A'}<br>
          –¢–µ–∫—É—â–∏–π: ${getWeightName(currentWeight)}
        </div>
        <div class="popup-option" data-weight="1">
          <div class="color-line" style="background-color: #8B4513;"></div>
          <span>–ó–∞–≤–∞–ª ${currentWeight === 1 ? '‚úì' : ''}</span>
        </div>
        <div class="popup-option" data-weight="2">
          <div class="color-line" style="background-color: #ff0000;"></div>
          <span>–®–∫—É—Ä–æ–¥–µ—Ä ${currentWeight === 2 ? '‚úì' : ''}</span>
        </div>
        <div class="popup-option" data-weight="3">
          <div class="color-line" style="background-color: #ff6700;"></div>
          <span>–ü—Ä–æ—Ö–æ–¥ —Å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ–º ${currentWeight === 3 ? '‚úì' : ''}</span>
        </div>
        <div class="popup-option" data-weight="4">
          <div class="color-line" style="background-color: #0066ff;"></div>
          <span>–û–±–≤–æ–¥–Ω–µ–Ω–Ω—ã–π —à—Ç—Ä–µ–∫ ${currentWeight === 4 ? '‚úì' : ''}</span>
        </div>
        <div class="popup-option" data-weight="5">
          <div class="color-line" style="background-color: #006400;"></div>
          <span>–°–≤–æ–±–æ–¥–Ω—ã–π –ø—Ä–æ—Ö–æ–¥ ${currentWeight === 5 ? '‚úì' : ''}</span>
        </div>
        <div class="comment-section">
          <div class="comment-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</div>
          ${currentComment ? `
            <div class="comment-text" id="comment-display">${currentComment}</div>
            <button class="comment-edit-btn" id="edit-comment-btn">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          ` : `
            <div class="no-comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</div>
            <button class="comment-edit-btn" id="edit-comment-btn">‚úèÔ∏è –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
          `}
          <div id="comment-edit-section" style="display: none;">
            <textarea class="comment-input" id="comment-input" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">${currentComment || ''}</textarea>
            <button class="comment-save-btn" id="save-comment-btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
          </div>
        </div>
      `;

      div.querySelectorAll('.popup-option').forEach(item => {
        item.addEventListener('click', async (e) => {
          e.stopPropagation();
          const newWeight = parseInt(item.dataset.weight, 10);
          
          if (documentId) {
            const success = await updateWeightInFirestore(documentId, newWeight);
            if (success) {
              console.log('Weight updated successfully');
              updateFeatureStyle(feature, newWeight);
              showSaveNotification();
              map.closePopup();
            } else {
              alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.');
            }
          } else {
            alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç –≤ –±–∞–∑–µ');
          }
        });
      });

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
      const editCommentBtn = div.querySelector('#edit-comment-btn');
      const commentEditSection = div.querySelector('#comment-edit-section');
      const saveCommentBtn = div.querySelector('#save-comment-btn');
      const commentInput = div.querySelector('#comment-input');

      editCommentBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        commentEditSection.style.display = 'block';
        editCommentBtn.style.display = 'none';
      });

      saveCommentBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const newComment = commentInput.value.trim();
        
        if (documentId) {
          const success = await updateCommentInFirestore(documentId, newComment);
          if (success) {
            console.log('Comment updated successfully');
            showSaveNotification('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
            const commentDisplay = div.querySelector('#comment-display');
            if (commentDisplay) {
              commentDisplay.textContent = newComment;
            } else {
              // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ –±—ã–ª–æ
              const commentSection = div.querySelector('.comment-section');
              const noCommentDiv = commentSection.querySelector('.no-comment');
              if (noCommentDiv) {
                noCommentDiv.style.display = 'none';
              }
              const newCommentDisplay = document.createElement('div');
              newCommentDisplay.className = 'comment-text';
              newCommentDisplay.id = 'comment-display';
              newCommentDisplay.textContent = newComment;
              commentSection.insertBefore(newCommentDisplay, editCommentBtn);
            }
            
            commentEditSection.style.display = 'none';
            editCommentBtn.style.display = 'block';
          } else {
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.');
          }
        } else {
          alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç –≤ –±–∞–∑–µ');
        }
      });
    }

    return div;
  }

  function updateFeatureStyle(feature, newWeight) {
    networkLayerGroup.eachLayer(layer => {
      if (layer.options?.featureRef === feature) {
        const currentZoom = map.getZoom();
        const baseWeight = Math.max(getRouteWeightByZoom(currentZoom), 3);
        
        layer.setStyle({ 
          color: getRouteColor(newWeight),
          weight: baseWeight,
          opacity: 0.8
        });
        
        layer.options.featureRef.properties.weight = newWeight;
      }
    });
  }

  async function loadGeoJson(url) {
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω GeoJSON –∏–∑ ${url}:`, data.features?.length, '—Ñ–∏—á');
      return data;
    } catch (e) {
      console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${url}:`, e);
      return { type: "FeatureCollection", features: [] };
    }
  }

  async function initializeMap() {
    geoJsonData = await loadGeoJson('data/routes.geojson');
    
    const firestoreLoaded = await loadFirestoreData();
    if (!firestoreLoaded) {
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
      return;
    }

    const mergedFeatures = geoJsonData.features.map(feature => {
      const objectId = feature.properties?.OBJECTID;
      let firestoreProps = null;
      for (let [docId, data] of firestoreData) {
        if (data.fb_objectid == objectId) {
          firestoreProps = data;
          break;
        }
      }
      if (firestoreProps) {
        return {
          ...feature,
          properties: {
            ...feature.properties,
            ...firestoreProps
          }
        };
      }
      return feature;
    });

    geoJsonData.features = mergedFeatures;

    const allCoords = [];
    mergedFeatures.forEach(f => {
      if (!f.geometry) return;
      let lines = [];
      if (f.geometry.type === 'LineString') lines = [f.geometry.coordinates];
      else if (f.geometry.type === 'MultiLineString') lines = f.geometry.coordinates;
      else return;

      lines.forEach(coords => {
        coords.forEach(pt => allCoords.push(pt));
      });
    });

    if (allCoords.length === 0) return;

    const xs = allCoords.map(c => c[0]);
    const ys = allCoords.map(c => c[1]);
    
    mapBounds = [
      [Math.min(...ys), Math.min(...xs)],
      [Math.max(...ys), Math.max(...xs)]
    ];

    console.log('Bounds –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫–∞—Ä—Ç:', mapBounds);

    createTileLayer('custom');
    allPointsGeoJson = await loadGeoJson('data/points.geojson');
    
    console.log('–ö–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –õ–∏–Ω–∏–π:', mergedFeatures.length);
  }

  // === –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π ===
  function setupAuth() {
    const authPanel = document.getElementById('auth-panel');
    const userInfo = document.getElementById('user-info');
    const userEmail = document.getElementById('user-email');
    const userRole = document.getElementById('user-role');
    const logoutBtn = document.getElementById('logout-btn');
    const anonymousButton = document.getElementById('anonymous-button');
    
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const loginTab = document.querySelector('[data-tab="login"]');
    const registerTab = document.querySelector('[data-tab="register"]');
    const authMessage = document.getElementById('auth-message');

    loginTab.addEventListener('click', () => switchAuthTab('login'));
    registerTab.addEventListener('click', () => switchAuthTab('register'));

    function switchAuthTab(tab) {
      loginTab.classList.toggle('active', tab === 'login');
      registerTab.classList.toggle('active', tab === 'register');
      loginForm.classList.toggle('active', tab === 'login');
      registerForm.classList.toggle('active', tab === 'register');
      clearAuthMessage();
    }

    function clearAuthMessage() {
      authMessage.innerHTML = '';
      authMessage.className = 'auth-message';
    }

    function showAuthMessage(message, type) {
      authMessage.innerHTML = message;
      authMessage.className = `auth-message auth-${type}`;
    }

    const registerPassword = document.getElementById('register-password');
    const registerPasswordConfirm = document.getElementById('register-password-confirm');
    const passwordMatchMessage = document.getElementById('password-match-message');
    const registerButton = document.getElementById('register-button');

    function checkPasswordMatch() {
      const password = registerPassword.value;
      const confirmPassword = registerPasswordConfirm.value;
      
      if (password === '' || confirmPassword === '') {
        passwordMatchMessage.innerHTML = '';
        registerButton.disabled = true;
        return;
      }
      
      if (password === confirmPassword) {
        passwordMatchMessage.innerHTML = '‚úì –ü–∞—Ä–æ–ª–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
        passwordMatchMessage.className = 'password-match';
        registerButton.disabled = password.length < 6;
      } else {
        passwordMatchMessage.innerHTML = '‚úó –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
        passwordMatchMessage.className = 'password-mismatch';
        registerButton.disabled = true;
      }
    }

    registerPassword.addEventListener('input', checkPasswordMatch);
    registerPasswordConfirm.addEventListener('input', checkPasswordMatch);

    document.getElementById('register-button').addEventListener('click', async () => {
      const name = document.getElementById('register-name').value.trim();
      const email = document.getElementById('register-email').value.trim();
      const password = document.getElementById('register-password').value;
      
      if (!name) {
        showAuthMessage('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è', 'error');
        return;
      }
      
      if (!email) {
        showAuthMessage('–í–≤–µ–¥–∏—Ç–µ email', 'error');
        return;
      }
      
      if (password.length < 6) {
        showAuthMessage('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return;
      }

      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        await user.updateProfile({
          displayName: name
        });
        
        await user.sendEmailVerification();
        
        localStorage.setItem('editor_name', name);
        
        showAuthMessage(
          '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à—É –ø–æ—á—Ç—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email.',
          'success'
        );
        
        setTimeout(() => {
          switchAuthTab('login');
          document.getElementById('register-name').value = '';
          document.getElementById('register-email').value = '';
          document.getElementById('register-password').value = '';
          document.getElementById('register-password-confirm').value = '';
          passwordMatchMessage.innerHTML = '';
          registerButton.disabled = true;
        }, 3000);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
        let errorMessage = '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ';
        
        switch (error.code) {
          case 'auth/email-already-in-use':
            errorMessage += '–≠—Ç–æ—Ç email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
            break;
          case 'auth/invalid-email':
            errorMessage += '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email';
            break;
          case 'auth/weak-password':
            errorMessage += '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º —Å–ª–∞–±—ã–π';
            break;
          case 'auth/operation-not-allowed':
            errorMessage += '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ email –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
            break;
          default:
            errorMessage += error.message;
        }
        
        showAuthMessage(errorMessage, 'error');
      }
    });

    async function signInAnonymously() {
      try {
        await auth.signInAnonymously();
      } catch (error) {
        showAuthMessage('–û—à–∏–±–∫–∞ –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –≤—Ö–æ–¥–∞: ' + error.message, 'error');
      }
    }

    async function signInWithEmail() {
      const email = document.getElementById('auth-email').value;
      const password = document.getElementById('auth-password').value;
      
      if (!email || !password) {
        showAuthMessage('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å', 'error');
        return;
      }
      
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
        let errorMessage = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ';
        
        switch (error.code) {
          case 'auth/user-not-found':
            errorMessage += '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
            break;
          case 'auth/wrong-password':
            errorMessage += '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
            break;
          case 'auth/invalid-email':
            errorMessage += '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email';
            break;
          case 'auth/user-disabled':
            errorMessage += '–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω';
            break;
          default:
            errorMessage += error.message;
        }
        
        showAuthMessage(errorMessage, 'error');
      }
    }

    async function logout() {
      try {
        await auth.signOut();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:', error);
      }
    }

    anonymousButton.addEventListener('click', signInAnonymously);
    document.getElementById('auth-button').addEventListener('click', signInWithEmail);
    logoutBtn.addEventListener('click', logout);

    auth.onAuthStateChanged((user) => {
      if (user) {
        authPanel.style.display = 'none';
        clearAuthMessage();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        currentUserEmail = user.email;
        
        if (user.isAnonymous) {
          currentUserRole = 'anonymous';
          userEmail.textContent = '–ì–æ—Å—Ç—å';
          userRole.textContent = '—Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä';
          currentUserEmail = null;
        } else {
          currentUserRole = 'authenticated';
          userEmail.textContent = user.email;
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç
          const canExport = canUserExport();
          userRole.textContent = user.emailVerified 
            ? (canExport ? '—Ä–µ–¥–∞–∫—Ç–æ—Ä + —ç–∫—Å–ø–æ—Ä—Ç' : '—Ä–µ–¥–∞–∫—Ç–æ—Ä') 
            : '—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email';
          
          const editorName = user.displayName || user.email;
          if (!localStorage.getItem('editor_name')) {
            localStorage.setItem('editor_name', editorName);
          }
          
          if (!user.emailVerified) {
            showAuthMessage(
              '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∞—à email –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. ' +
              '–ü–∏—Å—å–º–æ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –≤–∞—à—É –ø–æ—á—Ç—É.',
              'error'
            );
          }
        }
        
        userInfo.style.display = 'flex';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
        updateExportButtonState();
        
        initializeMap();
      } else {
        authPanel.style.display = 'block';
        userInfo.style.display = 'none';
        currentUserRole = 'anonymous';
        currentUserEmail = null;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
        updateExportButtonState();
        
        // –û—á–∏—â–∞–µ–º –∫–∞—Ä—Ç—É
        if (networkLayerGroup) networkLayerGroup.clearLayers();
        if (currentImageOverlay) {
          map.removeLayer(currentImageOverlay);
          currentImageOverlay = null;
        }
        if (currentTileLayer) {
          map.removeLayer(currentTileLayer);
          currentTileLayer = null;
        }
      }
    });

    document.querySelectorAll('.auth-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        clearAuthMessage();
        document.getElementById('auth-email').value = '';
        document.getElementById('auth-password').value = '';
      });
    });
  }

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ===
  document.addEventListener('DOMContentLoaded', () => {
    map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: 0.05,
      maxZoom: 5,
      zoomControl: false,
      tap: false
    });

    networkLayerGroup = L.layerGroup().addTo(map);

    document.getElementById('zoom-in').addEventListener('click', () => {
      if (map.getZoom() < map.getMaxZoom()) map.zoomIn();
    });
    document.getElementById('zoom-out').addEventListener('click', () => {
      if (map.getZoom() > map.getMinZoom()) map.zoomOut();
    });

    document.getElementById('background-select').addEventListener('change', function(e) {
      createTileLayer(e.target.value);
    });

    setupAuth();

    const menuButton = document.getElementById('menu-button');
    const dropdownMenu = document.getElementById('dropdown-menu');
    let menuOpen = false;
    menuButton.addEventListener('click', (e) => {
      e.stopPropagation();
      menuOpen = !menuOpen;
      dropdownMenu.classList.toggle('active', menuOpen);
    });
    document.addEventListener('click', () => {
      if (menuOpen) {
        menuOpen = false;
        dropdownMenu.classList.remove('active');
      }
    });
    dropdownMenu.addEventListener('click', (e) => e.stopPropagation());

    const legendBtn = document.getElementById('legend-btn');
    const legendPanel = document.getElementById('legend-panel');
    let legendOpen = false;
    legendBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      legendOpen = !legendOpen;
      legendPanel.style.display = legendOpen ? 'block' : 'none';
    });
    document.addEventListener('click', (e) => {
      if (legendOpen && !legendPanel.contains(e.target) && e.target !== legendBtn) {
        legendOpen = false;
        legendPanel.style.display = 'none';
      }
    });
    legendPanel.addEventListener('click', (e) => e.stopPropagation());

    const searchBtn = document.getElementById('search-btn');
    const searchInput = document.getElementById('search-input');
    const searchPanel = document.getElementById('search-panel');

    searchBtn.addEventListener('click', () => {
      const isVisible = searchPanel.style.display === 'block';
      searchPanel.style.display = isVisible ? 'none' : 'block';
      if (!isVisible) searchInput.focus();
    });

    searchInput.addEventListener('input', (e) => performSearch(e.target.value));
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        searchPanel.style.display = 'none';
        searchInput.value = '';
      }
    });

    document.addEventListener('click', (e) => {
      if (!searchPanel.contains(e.target) && e.target !== searchBtn) {
        searchPanel.style.display = 'none';
      }
    });

    document.getElementById('export-btn').addEventListener('click', () => {
      saveRoutesToFile();
    });
  });

  async function performSearch(query) {
    const resultsContainer = document.getElementById('search-results');
    resultsContainer.innerHTML = '';
    if (!query.trim() || !allPointsGeoJson) {
      resultsContainer.style.display = 'none';
      return;
    }

    const q = query.trim().toLowerCase();
    const matches = [];
    allPointsGeoJson.features.forEach(feature => {
      if (feature.geometry.type !== "Point") return;
      const name = feature.properties?.Name;
      const coords = feature.geometry.coordinates;
      if (!name || !coords?.[0] || !coords?.[1]) return;
      if (name.toLowerCase().includes(q)) {
        matches.push({ name, coords });
      }
    });

    if (matches.length === 0) {
      resultsContainer.style.display = 'none';
      return;
    }

    matches.sort((a, b) => a.name.localeCompare(b.name, 'ru'));
    matches.slice(0, 20).forEach(item => {
      const div = document.createElement('div');
      div.className = 'search-result-item';
      div.textContent = item.name;
      div.setAttribute('data-lng', item.coords[0]);
      div.setAttribute('data-lat', item.coords[1]);
      div.addEventListener('click', (e) => {
        const lng = parseFloat(e.target.getAttribute('data-lng'));
        const lat = parseFloat(e.target.getAttribute('data-lat'));
        if (!isNaN(lng) && !isNaN(lat)) {
          let targetLatLng;
          if (currentMapType === 'custom' || currentMapType === 'custom2') {
            targetLatLng = [lat, lng];
          } else {
            const [convertedLng, convertedLat] = webMercatorToWGS84(lng, lat);
            targetLatLng = [convertedLat, convertedLng];
          }
          
          map.setView(targetLatLng, Math.max(map.getZoom(), 15));
          const highlight = L.circle(targetLatLng, {
            radius: 50,
            color: '#d32f2f',
            fillColor: '#ff6b6b',
            weight: 2,
            fillOpacity: 0.5
          }).addTo(map);
          setTimeout(() => map.removeLayer(highlight), 3000);
          document.getElementById('search-panel').style.display = 'none';
          document.getElementById('search-input').value = '';
        }
      });
      resultsContainer.appendChild(div);
    });
    resultsContainer.style.display = 'block';
  }
</script>
</body>
</html>